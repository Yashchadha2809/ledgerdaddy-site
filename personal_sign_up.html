<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Resend Verification with Timer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors:{
            brandPrimary:"#111827",
            brandAccent:"#2563EB",
            brandMuted:"#6B7280",
            brandBorder:"#E5E7EB",
            brandBg:"#F9FAFB"
          },
          boxShadow:{ lift:"0 20px 50px rgba(17,24,39,.20)" }
        }
      }
    }
  </script>
</head>
<body class="min-h-full bg-brandBg text-brandPrimary">
  <main class="max-w-md mx-auto px-4 py-12">
    <h1 class="text-2xl font-bold mb-2">Resend email verification</h1>
    <p class="text-sm text-brandMuted mb-6">
      Enter your email. After sending, a popup shows a 60s timer. You can resend again when the timer finishes.
    </p>

    <label for="email" class="block text-sm font-medium mb-1">Email</label>
    <input id="email" type="email" required
           class="w-full rounded-lg border border-brandBorder px-3 py-2 mb-4 outline-none focus:ring-2 focus:ring-brandAccent"
           placeholder="you@example.com" />

    <button id="resendBtn"
            class="w-full rounded-lg bg-brandAccent text-white px-4 py-2 font-medium disabled:opacity-50 disabled:cursor-not-allowed">
      Resend verification link
    </button>

    <p id="inlineMsg" class="mt-3 text-sm"></p>

    <!-- Toast -->
    <div id="toast"
         class="hidden mt-4 rounded-lg border border-brandBorder bg-white px-4 py-3 text-sm shadow">
    </div>
  </main>

  <!-- Modal (Popup) -->
  <div id="modalRoot"
       class="hidden fixed inset-0 z-50 items-center justify-center">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/40" aria-hidden="true"></div>

    <!-- Dialog -->
    <div role="dialog" aria-modal="true" aria-labelledby="modalTitle"
         class="relative mx-4 w-full max-w-md rounded-2xl bg-white p-6 shadow-2xl shadow-black/10">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h2 id="modalTitle" class="text-lg font-semibold">Verification email sent</h2>
          <p id="modalSub" class="text-sm text-brandMuted mt-1">
            You can request another link after the timer finishes.
          </p>
        </div>
        <button id="modalClose"
                class="rounded-lg border border-brandBorder px-2 py-1 text-sm hover:bg-brandBg"
                aria-label="Close popup">
          ✕
        </button>
      </div>

      <div class="mt-5 grid gap-3">
        <div class="flex items-baseline gap-2">
          <span class="text-sm text-brandMuted">Next resend in</span>
          <span id="countdown" class="text-2xl font-bold tabular-nums">60s</span>
        </div>

        <div class="h-2 w-full rounded-full bg-brandBg border border-brandBorder overflow-hidden">
          <div id="progress" class="h-full bg-brandAccent" style="width:0%"></div>
        </div>

        <div id="modalHint" class="text-xs text-brandMuted">
          Tip: Don’t see it? Check spam/promotions. The link may take a few seconds to arrive.
        </div>
      </div>

      <div class="mt-6 flex items-center justify-end gap-3">
        <button id="resendNow"
                class="rounded-lg bg-brandAccent text-white px-4 py-2 font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                disabled>
          Resend now
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    // ===== 1) Init Supabase client =====
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const SUPABASE_URL = "https://YOUR_SUPABASE_URL.supabase.co";
    const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== 2) Elements =====
    const emailInput  = document.getElementById('email');
    const resendBtn   = document.getElementById('resendBtn');
    const inlineMsg   = document.getElementById('inlineMsg');
    const toast       = document.getElementById('toast');

    // Modal elements
    const modalRoot   = document.getElementById('modalRoot');
    const modalClose  = document.getElementById('modalClose');
    const countdownEl = document.getElementById('countdown');
    const progressEl  = document.getElementById('progress');
    const resendNow   = document.getElementById('resendNow');
    const modalSub    = document.getElementById('modalSub');

    // ===== 3) Cooldown helpers (per-email) =====
    const COOLDOWN_SECONDS = 60;
    const key = (email) => `resendCooldown:${(email || '').trim().toLowerCase()}`;

    function getRemainingMs(email) {
      const until = Number(localStorage.getItem(key(email))) || 0;
      return Math.max(0, until - Date.now());
    }
    function startCooldown(email, seconds = COOLDOWN_SECONDS) {
      localStorage.setItem(key(email), String(Date.now() + seconds * 1000));
    }

    // ===== 4) Toast helper =====
    function showToast(text, type = 'info') {
      toast.textContent = text;
      toast.classList.remove('hidden');
      toast.classList.remove('border-green-200', 'text-green-800');
      toast.classList.remove('border-red-200', 'text-red-800');
      toast.classList.remove('border-brandBorder', 'text-brandPrimary');

      if (type === 'success') {
        toast.classList.add('border-green-200', 'text-green-800');
      } else if (type === 'error') {
        toast.classList.add('border-red-200', 'text-red-800');
      } else {
        toast.classList.add('border-brandBorder', 'text-brandPrimary');
      }
      setTimeout(() => toast.classList.add('hidden'), 6000);
    }

    // ===== 5) Modal helpers (open/close, countdown, progress) =====
    let timerId = null;
    let totalMs = COOLDOWN_SECONDS * 1000;

    function openModal() {
      modalRoot.classList.remove('hidden');
      modalRoot.classList.add('flex');
      // Trap focus to modal close for basic accessibility
      modalClose.focus();
      document.addEventListener('keydown', escToClose, { once: true });
    }
    function closeModal() {
      modalRoot.classList.add('hidden');
      modalRoot.classList.remove('flex');
      clearInterval(timerId);
      timerId = null;
    }
    function escToClose(e) {
      if (e.key === 'Escape') closeModal();
    }

    function updateTimerUI(remainingMs) {
      const s = Math.ceil(remainingMs / 1000);
      countdownEl.textContent = `${s}s`;
      const pct = Math.min(100, Math.max(0, ((totalMs - remainingMs) / totalMs) * 100));
      progressEl.style.width = `${pct}%`;

      if (remainingMs <= 0) {
        countdownEl.textContent = `0s`;
        progressEl.style.width = '100%';
        resendNow.disabled = false;
        modalSub.textContent = 'You can request another link now.';
      } else {
        resendNow.disabled = true;
        modalSub.textContent = 'You can request another link after the timer finishes.';
      }
    }

    function startCountdown(email) {
      clearInterval(timerId);
      totalMs = COOLDOWN_SECONDS * 1000;
      function tick() {
        const remaining = getRemainingMs(email);
        updateTimerUI(remaining);
        if (remaining <= 0) {
          clearInterval(timerId);
          timerId = null;
        }
      }
      tick();
      timerId = setInterval(tick, 250);
    }

    // ===== 6) Core resend action =====
    async function doResend(email) {
      // Prevent hitting Supabase if still cooling
      if (getRemainingMs(email) > 0) {
        openModal();
        startCountdown(email);
        showToast('Please wait for the cooldown to finish before resending.', 'error');
        return;
      }

      try {
        resendBtn.disabled = true;
        resendBtn.textContent = 'Sending...';
        inlineMsg.textContent = '';

        const { data, error } = await supabase.auth.resend({
          type: 'signup',
          email
        });

        if (error) {
          const hint =
            error.message?.toLowerCase().includes('rate limit') ? ' (rate limited)' :
            error.message?.toLowerCase().includes('not found')   ? ' (email not found—sign up first?)' :
            '';
          showToast(`Failed to resend: ${error.message}${hint}`, 'error');
          return;
        }

        // Success: start cooldown + open modal with timer
        startCooldown(email, COOLDOWN_SECONDS);
        openModal();
        startCountdown(email);
        showToast('Verification email sent. Check your inbox.', 'success');
      } catch (e) {
        showToast(`Unexpected error: ${e?.message || e}`, 'error');
      } finally {
        resendBtn.disabled = false;
        resendBtn.textContent = 'Resend verification link';
      }
    }

    // ===== 7) Wire up buttons =====
    resendBtn.addEventListener('click', async () => {
      const email = emailInput.value.trim().toLowerCase();
      if (!email) {
        showToast('Please enter your email address.', 'error');
        emailInput.focus();
        return;
      }
      await doResend(email);
    });

    resendNow.addEventListener('click', async () => {
      const email = emailInput.value.trim().toLowerCase();
      if (!email) {
        showToast('Please enter your email address.', 'error');
        emailInput.focus();
        return;
      }
      await doResend(email);
    });

    modalClose.addEventListener('click', closeModal);
    modalRoot.addEventListener('click', (e) => {
      // click on backdrop closes modal
      if (e.target === modalRoot) closeModal();
    });

    // ===== 8) Respect existing cooldown on load (if email autofilled) =====
    window.addEventListener('DOMContentLoaded', () => {
      const email = emailInput.value.trim().toLowerCase();
      if (email && getRemainingMs(email) > 0) {
        openModal();
        startCountdown(email);
      }
    });

    // Update modal timer when user types a different email (per-email cooldown)
    emailInput.addEventListener('input', () => {
      const email = emailInput.value.trim().toLowerCase();
      if (modalRoot.classList.contains('hidden')) return;
      startCountdown(email);
    });
  </script>
</body>
</html>

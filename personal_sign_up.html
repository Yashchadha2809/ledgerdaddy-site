<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Resend Verification – Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors:{
            brandPrimary:"#111827",
            brandAccent:"#2563EB",
            brandMuted:"#6B7280",
            brandBorder:"#E5E7EB",
            brandBg:"#F9FAFB"
          }
        }
      }
    }
  </script>
</head>
<body class="min-h-full bg-brandBg text-brandPrimary">
  <main class="max-w-md mx-auto px-4 py-12">
    <h1 class="text-2xl font-bold mb-4">Resend email verification</h1>
    <p class="text-sm text-brandMuted mb-6">
      Enter your email and click “Resend verification link”. You can resend once every 60 seconds.
    </p>

    <label for="email" class="block text-sm font-medium mb-1">Email</label>
    <input id="email" type="email" required
           class="w-full rounded-lg border border-brandBorder px-3 py-2 mb-4 outline-none focus:ring-2 focus:ring-brandAccent"
           placeholder="you@example.com" />

    <button id="resendBtn"
            class="w-full rounded-lg bg-brandAccent text-white px-4 py-2 font-medium disabled:opacity-50 disabled:cursor-not-allowed">
      Resend verification link
    </button>

    <p id="resendMsg" class="mt-3 text-sm"></p>

    <div id="toast"
         class="hidden mt-4 rounded-lg border border-brandBorder bg-white px-4 py-3 text-sm shadow">
    </div>
  </main>

  <script type="module">
    // ===== 1) Init Supabase client =====
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const SUPABASE_URL = "https://nkvrhaxpoehqcgoamjhq.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5rdnJoYXhwb2VocWNnb2FtamhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3OTc5MDcsImV4cCI6MjA3MTM3MzkwN30.I6azwaIiEsQ_EjFRXtIZFTvpcc_g6NccsC3pJdWQPks";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== 2) Elements =====
    const emailInput = document.getElementById('email');
    const btn        = document.getElementById('resendBtn');
    const msg        = document.getElementById('resendMsg');
    const toast      = document.getElementById('toast');

    // ===== 3) Cooldown helpers (per-email) =====
    const COOLDOWN_SECONDS = 60;

    const key = (email) => `resendCooldown:${(email || '').trim().toLowerCase()}`;

    function getRemainingMs(email) {
      const until = Number(localStorage.getItem(key(email))) || 0;
      return Math.max(0, until - Date.now());
    }

    function startCooldown(email, seconds = COOLDOWN_SECONDS) {
      localStorage.setItem(key(email), String(Date.now() + seconds * 1000));
    }

    let timerId = null;
    function runCountdown(email) {
      clearInterval(timerId);
      function tick() {
        const remaining = getRemainingMs(email);
        if (remaining <= 0) {
          btn.disabled = false;
          msg.textContent = '';
          msg.className = "mt-3 text-sm";
          clearInterval(timerId);
          return;
        }
        btn.disabled = true;
        const s = Math.ceil(remaining / 1000);
        msg.textContent = `Please wait ${s}s before requesting again.`;
        msg.className = "mt-3 text-sm text-brandMuted";
      }
      tick();
      timerId = setInterval(tick, 500);
    }

    // Update countdown when the email field changes (so it respects per-email cooldown)
    emailInput.addEventListener('input', () => {
      const email = emailInput.value.trim().toLowerCase();
      runCountdown(email);
    });

    // ===== 4) Toast helper =====
    function showToast(text, type = 'info') {
      toast.textContent = text;
      toast.classList.remove('hidden');
      toast.classList.remove('border-green-200', 'text-green-800');
      toast.classList.remove('border-red-200', 'text-red-800');
      toast.classList.remove('border-brandBorder', 'text-brandPrimary');

      if (type === 'success') {
        toast.classList.add('border-green-200', 'text-green-800');
      } else if (type === 'error') {
        toast.classList.add('border-red-200', 'text-red-800');
      } else {
        toast.classList.add('border-brandBorder', 'text-brandPrimary');
      }

      // Auto hide after 6s
      setTimeout(() => toast.classList.add('hidden'), 6000);
    }

    // ===== 5) Resend handler =====
    btn.addEventListener('click', async () => {
      const email = emailInput.value.trim().toLowerCase();
      if (!email) {
        showToast('Please enter your email address.', 'error');
        emailInput.focus();
        return;
      }

      // Enforce cooldown
      if (getRemainingMs(email) > 0) {
        runCountdown(email);
        showToast('Please wait for the cooldown to finish before resending.', 'error');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Sending...';
      msg.textContent = '';

      try {
        // Supabase v2: resend verification for signups
        // Docs: supabase.auth.resend({ type: 'signup', email })
        const { data, error } = await supabase.auth.resend({
          type: 'signup',
          email
        });

        if (error) {
          // Common helpful hints
          const hint =
            error.message?.toLowerCase().includes('rate limit') ? ' (rate limited)' :
            error.message?.toLowerCase().includes('not found')   ? ' (email not found—sign up first?)' :
            '';

          showToast(`Failed to resend: ${error.message}${hint}`, 'error');
          btn.disabled = false;
          btn.textContent = 'Resend verification link';
          return;
        }

        // Success — start cooldown
        startCooldown(email, COOLDOWN_SECONDS);
        runCountdown(email);
        showToast('Verification email sent. Please check your inbox.', 'success');
      } catch (e) {
        showToast(`Unexpected error: ${e?.message || e}`, 'error');
        btn.disabled = false;
      } finally {
        btn.textContent = 'Resend verification link';
      }
    });

    // ===== 6) On load: if user already typed an email (autofill), respect cooldown =====
    window.addEventListener('DOMContentLoaded', () => {
      const email = emailInput.value.trim().toLowerCase();
      if (email) runCountdown(email);
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dashboard ‚Äì Ledgerdaddy</title>
  <meta name="theme-color" content="#111827" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors:{
            brandPrimary:"#111827",
            brandAccent:"#2563EB",
            brandSoft:"#EFF6FF",
            brandBorder:"#E5E7EB",
            brandMuted:"#6B7280",
            brandBg:"#F9FAFB"
          },
          boxShadow:{ lift:"0 10px 24px rgba(17,24,39,.06)" },
          backgroundImage:{ "soft-gradient":"linear-gradient(135deg, #EFF6FF 0%, #FFFFFF 100%)" },
          borderRadius: { xl2: '14px' }
        }
      }
    }
  </script>
  <style>
    .card{transition:transform .12s ease, box-shadow .2s ease}
    .card:hover{transform:translateY(-1px); box-shadow:0 10px 24px rgba(17,24,39,.06)}
    .kpi{background:#fff}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.58rem 1rem;border-radius:12px;font-weight:600}
    .btn-primary{background:#2563EB;color:#fff}
    .btn-primary:hover{filter:brightness(1.03);transform:translateY(-1px)}
    .btn-outline{border:1px solid #E5E7EB;background:#fff}
    .nav-link{position:relative}
    .nav-link:hover{color:#2563EB;background:rgba(37,99,235,.06)}
    .focus-ring:focus-visible{outline:2px solid #2563EB;outline-offset:2px;border-radius:12px}
    .badge{font-size:11px;padding:.2rem .5rem;border-radius:999px;border:1px solid rgba(37,99,235,.35);color:#2563EB}
  </style>
</head>
<body class="min-h-screen bg-brandBg text-brandPrimary">
  <!-- ===== Auth gate (robust) ===== -->
  <script>
    (function(){
      try {
        const here = location.pathname;
        const isLogin = here.endsWith('/log-in.html') || here === '/log-in.html';
        const raw = localStorage.getItem('chadaddy_user');
        let u = null;
        if (raw) { try { u = JSON.parse(raw); } catch { u = null; } }
        // OPTIONAL: for local testing, uncomment to auto-seed a demo user
        // if (!u) { u = { email:"demo@ledgerdaddy.test", name:"Demo User", ts: Date.now() }; localStorage.setItem('chadaddy_user', JSON.stringify(u)); }

        if ((!u || !u.email) && !isLogin) {
          // redirect only if not already on login
          window.location.href = './log-in.html';
        }
      } catch (e) {
        // If anything goes wrong, avoid redirect loops
        console.warn('Auth gate warning:', e);
      }
    })();
  </script>

  <!-- ===== Topbar ===== -->
  <header class="fixed top-0 inset-x-0 z-50 border-b border-brandBorder bg-white/90 backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <!-- Use dashboard as home to avoid "/" 404s -->
      <a href="./dashboard.html" id="homeLink" class="flex items-center gap-2" aria-label="Home">
        <span class="grid h-9 w-9 place-items-center rounded-xl bg-soft-gradient text-brandPrimary font-extrabold shadow">‚óÜ</span>
        <span class="text-xl font-bold">Ledgerdaddy</span>
        <span class="ml-2 hidden sm:inline-flex badge">AI Customs</span>
      </a>

      <nav class="hidden md:flex items-center gap-2 text-sm font-medium">
        <a href="./marketplace.html" class="nav-link px-3 py-2 rounded-lg">Marketplace</a>
        <a href="./calculator.html"   class="nav-link px-3 py-2 rounded-lg">Calculator</a>
        <a href="./hs-finder.html"    class="nav-link px-3 py-2 rounded-lg">HS Finder</a>
        <a href="./chat.html"         class="nav-link px-3 py-2 rounded-lg">Ask in Chat</a>
      </nav>

      <!-- Click-to-toggle account menu (no hover traps; mobile-safe) -->
      <div class="relative">
        <button id="accountBtn" type="button" class="btn btn-primary select-none">Account ‚ñæ</button>
        <div id="accountMenu"
             class="absolute right-0 mt-2 hidden bg-white border border-brandBorder rounded-xl shadow-lg w-56 py-1">
          <a href="./profile.html"      class="block px-4 py-2 text-sm hover:bg-brandSoft">Profile</a>
          <a href="./security.html"     class="block px-4 py-2 text-sm hover:bg-brandSoft">Security & Privacy</a>
          <a href="./payments.html"     class="block px-4 py-2 text-sm hover:bg-brandSoft">Payment Methods</a>
          <a href="./integrations.html" class="block px-4 py-2 text-sm hover:bg-brandSoft">Integrations</a>
          <button id="logoutBtn" type="button"
                  class="w-full text-left block px-4 py-2 text-sm text-red-600 hover:bg-red-50">
            Sign out
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- ===== Heading ===== -->
  <section class="pt-24 md:pt-28">
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div>
          <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight">Welcome, <span id="name">there</span> üëã</h1>
          <p class="text-brandMuted mt-2">Quick access to your tools and recent activity.</p>
        </div>
        <div class="flex items-center gap-2">
          <a href="./chat.html" class="btn btn-primary">Ask something</a>
          <a href="./calculator.html" class="btn btn-outline">New estimate</a>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== KPIs ===== -->
  <section class="max-w-7xl mx-auto px-4 mt-6 grid gap-3 sm:grid-cols-2 lg:grid-cols-4">
    <div class="kpi border border-brandBorder rounded-2xl p-4">
      <div class="text-xs uppercase text-brandMuted">Saved Estimates</div>
      <div class="mt-1 text-3xl font-extrabold tracking-tight">3</div>
    </div>
    <div class="kpi border border-brandBorder rounded-2xl p-4">
      <div class="text-xs uppercase text-brandMuted">HS Lookups</div>
      <div class="mt-1 text-3xl font-extrabold tracking-tight">2</div>
    </div>
    <div class="kpi border border-brandBorder rounded-2xl p-4">
      <div class="text-xs uppercase text-brandMuted">Broker Shortlists</div>
      <div class="mt-1 text-3xl font-extrabold tracking-tight">1</div>
    </div>
    <div class="kpi border border-brandBorder rounded-2xl p-4">
      <div class="text-xs uppercase text-brandMuted">Chat Threads</div>
      <div class="mt-1 text-3xl font-extrabold tracking-tight" id="kpiThreads">0</div>
    </div>
  </section>

  <!-- ===== Content ===== -->
  <main id="main" class="max-w-7xl mx-auto px-4 mt-8 grid gap-6 lg:grid-cols-[1fr,360px]">
    <!-- Left column -->
    <div class="grid gap-6">
      <!-- Quick actions -->
      <section class="bg-white border border-brandBorder rounded-2xl p-5 card">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold">Quick actions</h2>
          <div class="text-xs text-brandMuted">Common tasks</div>
        </div>
        <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3">
          <a href="./calculator.html" class="group border border-brandBorder rounded-xl p-4 text-left hover:border-brandAccent focus-ring">
            <div class="flex items-center gap-3">
              <div class="h-10 w-10 rounded-lg bg-brandSoft text-brandAccent grid place-items-center">‚àë</div>
              <div>
                <div class="text-sm font-semibold">Open Calculator</div>
                <div class="text-xs text-brandMuted">Start a new estimate</div>
              </div>
            </div>
          </a>
          <a href="./hs-finder.html" class="group border border-brandBorder rounded-xl p-4 text-left hover:border-brandAccent focus-ring">
            <div class="flex items-center gap-3">
              <div class="h-10 w-10 rounded-lg bg-brandSoft text-brandAccent grid place-items-center">HS</div>
              <div>
                <div class="text-sm font-semibold">HS Finder</div>
                <div class="text-xs text-brandMuted">Get code suggestions</div>
              </div>
            </div>
          </a>
          <a href="./marketplace.html" class="group border border-brandBorder rounded-xl p-4 text-left hover:border-brandAccent focus-ring">
            <div class="flex items-center gap-3">
              <div class="h-10 w-10 rounded-lg bg-brandSoft text-brandAccent grid place-items-center">üè¨</div>
              <div>
                <div class="text-sm font-semibold">Find Broker</div>
                <div class="text-xs text-brandMuted">Compare verified CHAs</div>
              </div>
            </div>
          </a>
          <a href="./chat.html" class="group border border-brandBorder rounded-xl p-4 text-left hover:border-brandAccent focus-ring">
            <div class="flex items-center gap-3">
              <div class="h-10 w-10 rounded-lg bg-brandSoft text-brandAccent grid place-items-center">üí¨</div>
              <div>
                <div class="text-sm font-semibold">Ask in Chat</div>
                <div class="text-xs text-brandMuted">ChatGPT-style helper</div>
              </div>
            </div>
          </a>
        </div>
      </section>

      <!-- Pinned tools -->
      <section class="bg-white border border-brandBorder rounded-2xl p-5 card">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold">Pinned tools</h2>
        </div>
        <div class="mt-4 grid md:grid-cols-2 gap-4">
          <article class="border border-brandBorder rounded-xl p-4">
            <div class="flex items-center justify-between">
              <h3 class="font-semibold">Calculator</h3>
              <a href="./calculator.html" class="text-brandAccent text-sm">Open ‚Üí</a>
            </div>
            <p class="text-sm text-brandMuted mt-1">Estimate BCD, IGST/VAT and landed cost.</p>
            <div class="text-xs text-brandMuted mt-2">Last used: 2 days ago</div>
          </article>
          <article class="border border-brandBorder rounded-xl p-4">
            <div class="flex items-center justify-between">
              <h3 class="font-semibold">HS Finder</h3>
              <a href="./hs-finder.html" class="text-brandAccent text-sm">Open ‚Üí</a>
            </div>
            <p class="text-sm text-brandMuted mt-1">Describe product ‚Üí get HS suggestions.</p>
            <div class="text-xs text-brandMuted mt-2">Last used: 4 days ago</div>
          </article>
          <article class="border border-brandBorder rounded-xl p-4">
            <div class="flex items-center justify-between">
              <h3 class="font-semibold">Marketplace</h3>
              <a href="./marketplace.html" class="text-brandAccent text-sm">Open ‚Üí</a>
            </div>
            <p class="text-sm text-brandMuted mt-1">Browse & compare verified customs brokers.</p>
            <div class="text-xs text-brandMuted mt-2">Last used: 1 week ago</div>
          </article>
          <article class="border border-brandBorder rounded-xl p-4">
            <div class="flex items-center justify-between">
              <h3 class="font-semibold">Ask in Chat</h3>
              <a href="./chat.html" class="text-brandAccent text-sm">Open ‚Üí</a>
            </div>
            <p class="text-sm text-brandMuted mt-1">Get instant help, ChatGPT-style.</p>
            <div class="text-xs text-brandMuted mt-2">Active: <span id="chatThreadsText">0 threads</span></div>
          </article>
        </div>
      </section>

      <!-- Recent items -->
      <section class="bg-white border border-brandBorder rounded-2xl p-5 card">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold">Recent items</h2>
          <div class="text-xs text-brandMuted">Demo</div>
        </div>
        <ul id="recentList" class="mt-3 grid gap-3 text-sm"></ul>
      </section>
    </div>

    <!-- Right column -->
    <aside class="grid gap-6">
      <section class="bg-white border border-brandBorder rounded-2xl p-5 card">
        <h3 class="text-lg font-semibold">Account</h3>
        <dl class="mt-3 text-sm">
          <div class="flex justify-between py-2 border-b border-brandBorder/60">
            <dt class="text-brandMuted">Email</dt>
            <dd id="email" class="font-medium">‚Äî</dd>
          </div>
          <div class="flex justify-between py-2 border-b border-brandBorder/60">
            <dt class="text-brandMuted">Member since</dt>
            <dd id="memberSince" class="font-medium">‚Äî</dd>
          </div>
        </dl>
        <button id="clearData" class="mt-4 text-xs underline text-brandAccent">Clear local data</button>
      </section>

      <section class="bg-white border border-brandBorder rounded-2xl p-5 card">
        <h3 class="text-lg font-semibold">What‚Äôs next?</h3>
        <ul class="mt-2 list-disc ml-5 text-sm text-brandPrimary/90">
          <li>Create a landed cost estimate in the <a class="text-brandAccent" href="./calculator.html">Calculator</a></li>
          <li>Try <a class="text-brandAccent" href="./hs-finder.html">HS Finder</a> with a product description</li>
          <li>Browse verified brokers in the <a class="text-brandAccent" href="./marketplace.html">Marketplace</a></li>
          <li>Ask quick questions in <a class="text-brandAccent" href="./chat.html">Chat</a></li>
        </ul>
      </section>
    </aside>
  </main>

  <footer class="text-center text-xs text-brandMuted mt-10 mb-8">
    ¬© <span id="year"></span> Ledgerdaddy
  </footer>

  <script>
    // Utility
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    // Footer year
    $('#year').textContent = new Date().getFullYear();

    // Session load (safe)
    let user = null;
    try {
      const raw = localStorage.getItem('chadaddy_user');
      if (raw) user = JSON.parse(raw);
    } catch (e) { user = null; }

    if (user) {
      $('#name').textContent = user.name || 'there';
      $('#email').textContent = user.email || '‚Äî';
      const d = new Date(user.ts || Date.now());
      $('#memberSince').textContent = d.toLocaleDateString();
    }

    // Demo "recent" list
    const recent = [
      { t:'Estimate ‚Ä¢ IN ‚Ä¢ HS 851713 ‚Ä¢ CIF', time:'2 days ago', link:'./calculator.html' },
      { t:'HS Finder ‚Ä¢ ‚ÄúLED downlight‚Äù',     time:'4 days ago',  link:'./hs-finder.html' },
      { t:'Broker shortlist ‚Ä¢ JNPT',         time:'1 week ago',  link:'./marketplace.html' },
      { t:'Chat ‚Ä¢ ‚ÄúDocs for EU furniture‚Äù',  time:'1 week ago',  link:'./chat.html' },
    ];
    $('#recentList').innerHTML = recent
      .map(r => `<li class="border border-brandBorder rounded-lg px-3 py-2 flex items-center justify-between">
        <a class="hover:text-brandAccent" href="${r.link}">${r.t}</a>
        <span class="text-brandMuted">${r.time}</span></li>`).join('');

    // Chat thread count
    try{
      const t = JSON.parse(localStorage.getItem('ld_chat_threads_v1')||'[]');
      const n = Array.isArray(t) ? t.length : 0;
      $('#kpiThreads').textContent = n;
      const tt = $('#chatThreadsText');
      if(tt) tt.textContent = n + (n===1?' thread':' threads');
    }catch{}

    // ===== Account dropdown (click toggle; closes on outside click) =====
    (function setupAccountMenu(){
      const btn = $('#accountBtn');
      const menu = $('#accountMenu');

      function close(){ menu.classList.add('hidden'); btn.setAttribute('aria-expanded', 'false'); }
      function open(){ menu.classList.remove('hidden'); btn.setAttribute('aria-expanded', 'true'); }

      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        const isOpen = !menu.classList.contains('hidden');
        isOpen ? close() : open();
      });

      // prevent menu clicks from bubbling (so clicking inside doesn't close or trigger anything else)
      menu.addEventListener('click', (e)=> e.stopPropagation());

      // click outside to close
      document.addEventListener('click', close);

      // Escape to close
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
    })();

    // ===== Logout =====
    $('#logoutBtn')?.addEventListener('click', (e) => {
      e.stopPropagation();
      try {
        localStorage.removeItem('chadaddy_user');
        // optional: also clear chat cache
        // localStorage.removeItem('ld_chat_threads_v1');
      } catch {}
      window.location.href = './log-in.html';
    });

    // ===== Clear local demo data =====
    $('#clearData').addEventListener('click', () => {
      localStorage.removeItem('chadaddy_user');
      localStorage.removeItem('ld_chat_threads_v1');
      alert('Local demo data cleared. You may need to sign in again.');
      // Optional: refresh to re-run auth gate
      // location.reload();
    });

    // ===== Home link safety (avoid "/" issues) =====
    // If you're already on dashboard, prevent redundant navigation.
    $('#homeLink').addEventListener('click', (e)=>{
      const here = location.pathname.replace(/\/+$/,'');
      if (here.endsWith('/dashboard.html') || here === '/dashboard.html') {
        e.preventDefault();
      }
    });
  </script>
</body>
</html>

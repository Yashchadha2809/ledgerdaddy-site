<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat Demo – Channels • Messages • Threads</title>
  <meta name="theme-color" content="#0ea5e9" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50: "#ecfeff",
              100: "#cffafe",
              200: "#a5f3fc",
              300: "#67e8f9",
              400: "#22d3ee",
              500: "#06b6d4",
              600: "#0891b2",
              700: "#0e7490",
              800: "#155e75",
              900: "#164e63",
            },
          },
          boxShadow: { soft: "0 10px 30px rgba(2,6,23,.08)" },
          borderRadius: { xl2: "16px" },
        },
      },
    };
  </script>
  <style>
    .scrollbar-thin::-webkit-scrollbar{height:8px;width:8px}
    .scrollbar-thin::-webkit-scrollbar-thumb{background:#e5e7eb;border-radius:8px}
    .fade-in{animation:fade .12s ease-out}
    @keyframes fade{from{opacity:.5;transform:translateY(2px)}to{opacity:1;transform:none}}
    .typing-dot{animation:pulse 1s infinite ease-in-out}
    .typing-dot:nth-child(2){animation-delay:.15s}
    .typing-dot:nth-child(3){animation-delay:.3s}
    @keyframes pulse{0%,80%,100%{opacity:.25}40%{opacity:1}}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.55rem .9rem;border-radius:10px;font-weight:600}
    .btn-ghost{background:transparent;border:1px solid #e5e7eb}
    .btn-ghost:hover{background:#f9fafb}
    .btn-brand{background:#06b6d4;color:#fff}
    .btn-brand:hover{filter:brightness(1.05)}
    .chip{font-size:12px;border:1px solid #e5e7eb;border-radius:999px;padding:.3rem .6rem;background:#fff}
    .chip:hover{border-color:#06b6d4;color:#0e7490}
    .bubble{max-width:min(80vw,760px)}
    .bubble-user{background:#0ea5e9;color:#fff;box-shadow:0 8px 22px rgba(14,165,233,.22)}
    .bubble-other{background:#fff;border:1px solid #e5e7eb;box-shadow:0 8px 22px rgba(2,6,23,.06)}
    .file-pill{border:1px solid #e5e7eb;border-radius:10px;padding:.35rem .6rem;font-size:12px;display:inline-flex;align-items:center;gap:.4rem;background:#fff}
    .emoji{cursor:pointer;user-select:none}
  </style>
</head>
<body class="h-full bg-slate-50 text-slate-900">
  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="flex items-center gap-2">
        <div class="h-9 w-9 grid place-items-center rounded-xl bg-gradient-to-tr from-brand-500 to-sky-500 text-white font-bold">◆</div>
        <div>
          <div class="font-bold leading-none">Chat Demo</div>
          <div class="text-[11px] text-slate-500 leading-none">Channels • Messages • Threads</div>
        </div>
      </div>
      <div class="ml-auto relative w-64 hidden md:block">
        <input id="globalSearch" placeholder="Search channels or users" class="w-full text-sm rounded-lg border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-200" />
        <div class="absolute right-2 top-1.5 text-slate-400">⌘K</div>
      </div>
      <button id="newChat" class="btn btn-brand">New Chat</button>
    </div>
  </header>

  <!-- App -->
  <main class="max-w-7xl mx-auto grid grid-rows-[1fr,auto] md:grid-rows-1 md:grid-cols-[300px,1fr,320px] gap-3 p-3 md:py-4">
    <!-- Channels -->
    <aside class="bg-white border border-slate-200 rounded-xl shadow-soft overflow-hidden flex flex-col h-[calc(100vh-110px)]">
      <div class="p-3 border-b border-slate-200">
        <div class="text-sm font-semibold flex items-center justify-between">
          Channels
          <button id="addChannel" class="chip">+ Create</button>
        </div>
        <div class="mt-2">
          <input id="channelSearch" placeholder="Search…" class="w-full text-sm rounded-lg border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-200" />
        </div>
      </div>
      <ul id="channelList" class="flex-1 overflow-auto scrollbar-thin divide-y divide-slate-100"></ul>
    </aside>

    <!-- Messages -->
    <section class="bg-white border border-slate-200 rounded-xl shadow-soft overflow-hidden flex flex-col h-[calc(100vh-110px)]">
      <!-- Channel header -->
      <div id="roomHeader" class="p-3 border-b border-slate-200 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-9 w-9 grid place-items-center rounded-xl bg-brand-100 text-brand-700 font-bold">#</div>
          <div>
            <div id="roomName" class="font-semibold">Welcome</div>
            <div id="roomMeta" class="text-xs text-slate-500">0 online • 0 members</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button id="pinRoom" class="chip">📌 Pin</button>
          <button id="muteRoom" class="chip">🔕 Mute</button>
          <button id="moreRoom" class="chip">⋯</button>
        </div>
      </div>

      <!-- Stream -->
      <div id="messageWrap" class="flex-1 overflow-auto p-3 md:p-4 space-y-3 scrollbar-thin bg-slate-50/60">
        <!-- date divider + messages injected here -->
      </div>

      <!-- Typing indicator -->
      <div id="typing" class="px-4 pb-2 text-xs text-slate-500 hidden">
        <span class="typing-dot inline-block w-2 h-2 rounded-full bg-slate-400"></span>
        <span class="typing-dot inline-block w-2 h-2 rounded-full bg-slate-400"></span>
        <span class="typing-dot inline-block w-2 h-2 rounded-full bg-slate-400"></span>
        <span class="ml-2">Someone is typing…</span>
      </div>

      <!-- Composer -->
      <div class="border-t border-slate-200 p-2 md:p-3 bg-white">
        <form id="composer" class="flex items-end gap-2">
          <input id="fileInput" type="file" class="hidden" multiple accept="image/*,.pdf,.csv,.txt,.json,.doc,.docx,.xls,.xlsx,.ppt,.pptx" />
          <label for="fileInput" class="btn btn-ghost" title="Upload files">📎</label>

          <div class="relative flex-1">
            <textarea id="chatInput" rows="1" placeholder="Message #welcome" class="w-full rounded-lg border border-slate-200 px-3 py-2 pr-20 resize-none max-h-40 focus:outline-none focus:ring-2 focus:ring-brand-200"></textarea>
            <div class="absolute right-2 top-1.5 flex items-center gap-1">
              <button type="button" id="emojiBtn" class="chip" title="Emoji">😊</button>
              <button type="button" id="giphyBtn" class="chip" title="GIF">GIF</button>
            </div>
          </div>

          <button id="sendBtn" type="submit" class="btn btn-brand">Send</button>
        </form>

        <!-- attachment tray -->
        <div id="attachTray" class="hidden mt-2 flex flex-wrap items-center gap-2">
          <div class="text-xs text-slate-500">Attachments:</div>
          <!-- pills injected -->
          <button id="clearAttach" class="chip text-red-600 border-red-200 hidden">Clear all</button>
        </div>

        <!-- quick replies -->
        <div class="mt-2 flex flex-wrap gap-2">
          <button class="chip qa" data-q="When will the shipment arrive?">ETA?</button>
          <button class="chip qa" data-q="Share HS code for LED bulbs">HS code LED</button>
          <button class="chip qa" data-q="What duty applies to HS 851713 in IN?">Duty 851713</button>
          <button class="chip qa" data-q="Required docs for wooden furniture to EU">Docs EU</button>
        </div>
      </div>
    </section>

    <!-- Right panel (thread / info) -->
    <aside class="bg-white border border-slate-200 rounded-xl shadow-soft overflow-hidden h-[calc(100vh-110px)] hidden lg:flex lg:flex-col">
      <div class="p-3 border-b border-slate-200 flex items-center justify-between">
        <div class="font-semibold">Details</div>
        <button id="closeThread" class="chip">Close</button>
      </div>
      <div id="threadWrap" class="flex-1 overflow-auto p-3 space-y-3 scrollbar-thin">
        <div class="text-sm text-slate-500">Select a message to open its thread, reactions, and attachments.</div>
      </div>
    </aside>
  </main>

  <!-- Templates -->
  <template id="dateDividerTpl">
    <div class="sticky top-1 z-10 w-full text-center">
      <span class="inline-block text-[11px] text-slate-600 bg-white/80 backdrop-blur border border-slate-200 rounded-full px-2 py-0.5">DATE</span>
    </div>
  </template>

  <template id="msgTpl">
    <article class="fade-in flex gap-2 md:gap-3">
      <img class="h-8 w-8 rounded-full ring-2 ring-white shadow" />
      <div class="bubble bubble-other rounded-2xl px-3 py-2 flex-1">
        <div class="flex items-center gap-2 text-xs text-slate-500">
          <span class="name font-semibold">Name</span>
          <span class="time">time</span>
          <span class="ml-auto receipt hidden">✓✓ Read</span>
        </div>
        <div class="content prose prose-sm max-w-none"></div>
        <div class="mt-2 flex items-center gap-2">
          <button class="chip react">😀</button>
          <button class="chip reply">↩︎ Reply</button>
          <button class="chip more">⋯</button>
        </div>
        <div class="mt-2 hidden attachments"></div>
        <div class="mt-2 hidden reactions"></div>
        <div class="mt-2 hidden thread"></div>
      </div>
    </article>
  </template>

  <template id="attachPillTpl">
    <a target="_blank" class="file-pill">
      <span>📄</span>
      <span class="name truncate max-w-[160px]"></span>
      <span class="size text-slate-500"></span>
    </a>
  </template>

  <script>
    // -----------------------------------
    // Mock data + Realtime stub
    // -----------------------------------
    const me = { id: "u_me", name: "You", avatar: "https://i.pravatar.cc/64?img=12" };
    const users = [
      me,
      { id:"u_amy", name:"Amy", avatar:"https://i.pravatar.cc/64?img=5"},
      { id:"u_max", name:"Max", avatar:"https://i.pravatar.cc/64?img=20"},
      { id:"u_lee", name:"Lee", avatar:"https://i.pravatar.cc/64?img=33"},
    ];
    let channels = [
      { id: "c_welcome", name:"#welcome", members: ["u_me","u_amy","u_max"], online: ["u_amy","u_me"], pinned:false, muted:false, messages: [] },
      { id: "c_ops", name:"#ops", members: ["u_me","u_amy","u_max","u_lee"], online: ["u_lee"], pinned:true, muted:false, messages: [] },
      { id: "c_random", name:"#random", members: ["u_me","u_amy"], online: [], pinned:false, muted:true, messages: [] },
    ];

    const realtime = {
      subscribe(channelId, cb){
        // simulate deliveries
        setInterval(()=>{
          if(Math.random()<0.2){
            const sender = users[Math.floor(Math.random()*(users.length-1))+1];
            cb({ type:"message.new", message: {
              id: crypto.randomUUID(), userId: sender.id, text: randomBotLine(),
              createdAt: Date.now(), attachments:[], reactions:{}, thread:[] }
            });
          }
        }, 5000);
      },
      send(channelId, message){
        // echo "delivered" and "read"
        setTimeout(()=> events.emit({ type:"message.delivered", messageId:message.id }), 500);
        setTimeout(()=> events.emit({ type:"message.read", messageId:message.id }), 1200);
      },
      typing(channelId, on){ events.emit({ type:"typing", on }); }
    };

    function randomBotLine(){
      const lines = [
        "Got it — checking that now.",
        "Can you share the invoice as a PDF?",
        "HS 851713 usually applies here.",
        "ETA looks like 4–6 days via air.",
        "Let me calculate the duty for you.",
      ];
      return lines[Math.floor(Math.random()*lines.length)];
    }

    // Simple event bus
    const events = {
      _cbs: [],
      on(cb){ this._cbs.push(cb); },
      emit(p){ this._cbs.forEach(fn=>fn(p)); }
    };

    // -----------------------------------
    // DOM helpers
    // -----------------------------------
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const fmtTime = ts => new Date(ts).toLocaleString([], {hour:'2-digit', minute:'2-digit'});
    const fmtDate = ts => new Date(ts).toLocaleDateString([], {day:"2-digit", month:"short", year:"numeric"});
    const sizeStr = b => (b/1024/1024).toFixed(1) + "MB";

    // -----------------------------------
    // State
    // -----------------------------------
    let currentChannelId = channels[0].id;
    let pendingFiles = []; // {file, url, id}

    // -----------------------------------
    // Channel UI
    // -----------------------------------
    function renderChannels(filter=""){
      const ul = $("#channelList");
      const q = filter.toLowerCase();
      ul.innerHTML = channels
        .filter(c=> c.name.toLowerCase().includes(q))
        .map(c=>{
          const unread = Math.random()<0.35 ? Math.floor(Math.random()*7)+1 : 0; // demo
          const active = c.id===currentChannelId ? "bg-slate-50" : "hover:bg-slate-50";
          const pin = c.pinned ? "📌" : "";
          const mute = c.muted ? "🔕" : "";
          return `
          <li>
            <button data-id="${c.id}" class="w-full px-3 py-2 ${active} text-left">
              <div class="flex items-center justify-between">
                <div class="font-medium">${c.name} <span class="text-slate-400">${pin}${mute}</span></div>
                ${unread?`<span class="text-[11px] bg-brand-500 text-white rounded-full px-1.5">${unread}</span>`:""}
              </div>
              <div class="text-[11px] text-slate-500">${c.online.length} online • ${c.members.length} members</div>
            </button>
          </li>`;
        }).join("");

      ul.querySelectorAll("button[data-id]").forEach(btn=>{
        btn.onclick = ()=> {
          currentChannelId = btn.getAttribute("data-id");
          loadChannel(currentChannelId);
          renderChannels($("#channelSearch").value);
        };
      });
    }

    function loadChannel(id){
      const ch = channels.find(c=>c.id===id);
      $("#roomName").textContent = ch.name;
      $("#roomMeta").textContent = `${ch.online.length} online • ${ch.members.length} members`;
      $("#chatInput").placeholder = `Message ${ch.name}`;
      renderMessages();
    }

    // -----------------------------------
    // Messages
    // -----------------------------------
    function ensureDateDivider(wrap, ts, prevTs){
      const d1 = fmtDate(ts), d2 = prevTs?fmtDate(prevTs):"";
      if(d1!==d2){
        const t = $("#dateDividerTpl").content.cloneNode(true);
        t.querySelector("span").textContent = d1;
        wrap.appendChild(t);
      }
    }

    function renderMessages(){
      const wrap = $("#messageWrap");
      const ch = channels.find(c=>c.id===currentChannelId);
      wrap.innerHTML = "";
      let lastTs = 0;
      ch.messages.forEach(m=>{
        ensureDateDivider(wrap, m.createdAt, lastTs);
        lastTs = m.createdAt;
        wrap.appendChild(renderMessageNode(m));
      });
      wrap.scrollTop = wrap.scrollHeight;
    }

    function renderMessageNode(m){
      const tpl = $("#msgTpl").content.cloneNode(true);
      const root = tpl.querySelector("article");
      const avatar = tpl.querySelector("img");
      const name = tpl.querySelector(".name");
      const time = tpl.querySelector(".time");
      const content = tpl.querySelector(".content");
      const receipt = tpl.querySelector(".receipt");
      const attachWrap = tpl.querySelector(".attachments");
      const reactBtn = tpl.querySelector(".react");
      const replyBtn = tpl.querySelector(".reply");
      const moreBtn = tpl.querySelector(".more");
      const bubble = tpl.querySelector(".bubble");

      const user = users.find(u=>u.id===m.userId) || me;
      avatar.src = user.avatar;
      avatar.alt = user.name;
      name.textContent = user.id===me.id ? "You" : user.name;
      time.textContent = fmtTime(m.createdAt);
      content.innerHTML = linkify(m.text);

      if(m.userId===me.id){
        root.classList.add("flex-row-reverse");
        bubble.classList.remove("bubble-other");
        bubble.classList.add("bubble-user");
        receipt.classList.remove("hidden");
      }

      // attachments
      if(m.attachments?.length){
        attachWrap.classList.remove("hidden");
        m.attachments.forEach(a=>{
          const pill = $("#attachPillTpl").content.cloneNode(true);
          const link = pill.querySelector("a");
          link.href = a.url;
          pill.querySelector(".name").textContent = a.name;
          pill.querySelector(".size").textContent = a.size ? sizeStr(a.size) : "";
          attachWrap.appendChild(pill);
        });
      }

      // reactions
      const reactionsEl = tpl.querySelector(".reactions");
      if(m.reactions && Object.keys(m.reactions).length){
        reactionsEl.classList.remove("hidden");
        reactionsEl.innerHTML = Object.entries(m.reactions).map(([emo, ids])=>{
          const mine = ids.includes(me.id) ? "ring-2 ring-brand-200" : "";
          return `<button class="chip emoji ${mine}" data-id="${m.id}" data-emoji="${emo}">${emo} <span class="text-slate-500">${ids.length}</span></button>`;
        }).join(" ");
      }

      // thread
      const threadEl = tpl.querySelector(".thread");
      if(m.thread?.length){
        threadEl.classList.remove("hidden");
        threadEl.innerHTML = m.thread.map(t=>`
          <div class="text-sm text-slate-700 flex items-start gap-2">
            <img src="${(users.find(u=>u.id===t.userId)||me).avatar}" class="h-5 w-5 rounded-full" />
            <div><strong class="mr-1">${(users.find(u=>u.id===t.userId)||me).name}:</strong>${linkify(t.text)}</div>
          </div>
        `).join("");
      }

      // actions
      reactBtn.onclick = ()=> openReactions(m.id, reactionsEl);
      replyBtn.onclick = ()=> openThread(m.id);
      moreBtn.onclick = (e)=> openMoreMenu(e, m.id);

      return root;
    }

    function linkify(text=""){
      const esc = text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
      return esc.replace(/(https?:\/\/[^\s]+)/g, '<a class="text-sky-600 underline" target="_blank" href="$1">$1</a>');
    }

    // -----------------------------------
    // Composer + Uploads
    // -----------------------------------
    const area = $("#chatInput");
    const form = $("#composer");
    const sendBtn = $("#sendBtn");
    const fileInput = $("#fileInput");
    const attachTray = $("#attachTray");
    const clearAttach = $("#clearAttach");

    let attach = []; // {name, url, type, size}

    fileInput.addEventListener("change", e=>{
      const files = [...e.target.files];
      files.forEach(f=> attach.push({ name:f.name, url: URL.createObjectURL(f), type:f.type, size:f.size }));
      renderAttachTray();
    });

    function renderAttachTray(){
      if(!attach.length){ attachTray.classList.add("hidden"); clearAttach.classList.add("hidden"); attachTray.innerHTML=""; return; }
      attachTray.classList.remove("hidden"); clearAttach.classList.remove("hidden");
      attachTray.innerHTML = `<div class="text-xs text-slate-500">Attachments:</div>` + attach.map((a,i)=>`
        <span class="file-pill">
          <span>${fileIcon(a.name)}</span>
          <span class="truncate max-w-[160px]" title="${a.name}">${a.name}</span>
          <span class="text-slate-500">${sizeStr(a.size)}</span>
          <button class="ml-1 chip" onclick="removeAttach(${i})">×</button>
        </span>
      `).join("");
    }
    window.removeAttach = (i)=>{ 
      try{ URL.revokeObjectURL(attach[i].url); }catch{}
      attach.splice(i,1); 
      renderAttachTray(); 
    };
    clearAttach.onclick = ()=>{
      attach.forEach(a=> URL.revokeObjectURL(a.url));
      attach=[]; renderAttachTray();
    };

    function fileIcon(name){
      const ext = (name.split(".").pop()||"").toLowerCase();
      if(["png","jpg","jpeg","gif","webp","heic"].includes(ext)) return "🖼️";
      if(["pdf"].includes(ext)) return "📄";
      if(["csv","xls","xlsx"].includes(ext)) return "📊";
      if(["doc","docx"].includes(ext)) return "📝";
      if(["ppt","pptx"].includes(ext)) return "📽️";
      if(["txt","json","md"].includes(ext)) return "📃";
      return "📎";
    }

    area.addEventListener("input", ()=>{
      area.style.height = "auto";
      area.style.height = Math.min(area.scrollHeight, 160) + "px";
      realtime.typing(currentChannelId, true);
      debouncedStopTyping();
    });

    const debouncedStopTyping = debounce(()=> realtime.typing(currentChannelId, false), 800);

    form.addEventListener("submit", (e)=>{
      e.preventDefault();
      send();
    });
    $("#emojiBtn").onclick = ()=> insertAtCursor(area, " 🙂");
    $("#giphyBtn").onclick  = ()=> insertAtCursor(area, " /giphy shipment");
    $$(".qa").forEach(b=> b.onclick = ()=> { area.value = b.getAttribute("data-q"); area.dispatchEvent(new Event("input")); area.focus(); });

    function send(){
      const text = area.value.trim();
      if(!text && !attach.length) return;
      const ch = channels.find(c=>c.id===currentChannelId);
      const msg = { id: crypto.randomUUID(), userId: me.id, text, createdAt: Date.now(), attachments: attach.slice(), reactions:{}, thread:[] };
      ch.messages.push(msg);
      renderMessages();
      area.value=""; area.style.height="auto";
      attach = []; renderAttachTray();
      realtime.send(currentChannelId, msg);
    }

    // -----------------------------------
    // Reactions + Thread
    // -----------------------------------
    function openReactions(messageId, container){
      const pop = document.createElement("div");
      pop.className = "fixed inset-0 z-50";
      pop.innerHTML = `
        <div class="absolute inset-0" onclick="this.parentElement.remove()"></div>
        <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 bg-white border border-slate-200 rounded-xl shadow-soft p-3">
          <div class="text-sm font-semibold mb-2">Add reaction</div>
          <div class="grid grid-cols-8 gap-1 text-2xl">
            ${["👍","😀","🎉","🙏","🔥","😮","❤️","🤝","🧠","📦","🕒","📝","✅","❗","📎","🧾"].map(e=>`<button class="emoji" data-emoji="${e}">${e}</button>`).join("")}
          </div>
        </div>`;
      document.body.appendChild(pop);
      pop.querySelectorAll(".emoji").forEach(btn=>{
        btn.onclick = ()=>{
          addReaction(messageId, btn.dataset.emoji);
          pop.remove();
        };
      });
    }

    function addReaction(messageId, emoji){
      const ch = channels.find(c=>c.id===currentChannelId);
      const m = ch.messages.find(x=>x.id===messageId);
      if(!m.reactions[emoji]) m.reactions[emoji] = [];
      const idx = m.reactions[emoji].indexOf(me.id);
      if(idx===-1) m.reactions[emoji].push(me.id); else m.reactions[emoji].splice(idx,1);
      renderMessages();
    }

    function openThread(messageId){
      const panel = $("#threadWrap");
      const ch = channels.find(c=>c.id===currentChannelId);
      const m = ch.messages.find(x=>x.id===messageId);
      document.querySelector("aside.lg\\:flex").classList.remove("hidden");
      panel.innerHTML = `
        <div class="text-sm text-slate-500">Thread in <strong>${ch.name}</strong></div>
        <div class="mt-2 border border-slate-200 rounded-xl p-3 bg-slate-50/50">
          <div class="font-semibold mb-1">Original message</div>
          <div>${linkify(m.text)}</div>
          ${m.attachments?.length? `<div class="mt-2">${m.attachments.map(a=>`<a class="file-pill" target="_blank" href="${a.url}">📄 ${a.name}</a>`).join(" ")}</div>`:""}
        </div>
        <div class="mt-3 font-semibold">Thread</div>
        <div id="threadMsgs" class="space-y-2 mt-1">
          ${(m.thread||[]).map(t=>`
          <div class="flex gap-2">
            <img src="${(users.find(u=>u.id===t.userId)||me).avatar}" class="h-6 w-6 rounded-full" />
            <div class="bg-white border border-slate-200 rounded-lg px-2 py-1">${linkify(t.text)}</div>
          </div>`).join("")}
        </div>
        <form id="threadComposer" class="mt-2 flex gap-2">
          <input id="threadInput" class="flex-1 border border-slate-200 rounded-lg px-3 py-2 text-sm" placeholder="Reply in thread…" />
          <button class="btn btn-brand text-sm">Send</button>
        </form>
      `;
      $("#threadComposer").onsubmit = (e)=>{
        e.preventDefault();
        const t = $("#threadInput").value.trim();
        if(!t) return;
        m.thread = m.thread || [];
        m.thread.push({ userId: me.id, text: t, createdAt: Date.now() });
        $("#threadInput").value="";
        openThread(messageId); // re-render
        renderMessages();
      };
      $("#closeThread").onclick = ()=> document.querySelector("aside.lg\\:flex").classList.add("hidden");
    }

    // -----------------------------------
    // Typing + receipts (mock)
    // -----------------------------------
    events.on(p=>{
      if(p.type==="typing"){ $("#typing").classList.toggle("hidden", !p.on); }
      if(p.type==="message.delivered" || p.type==="message.read"){
        const ch = channels.find(c=>c.id===currentChannelId);
        const m = ch.messages.find(x=>x.id===p.messageId);
        if(!m) return;
        const wrap = $("#messageWrap");
        // naive re-render for demo (receipts visible on my messages)
        renderMessages();
      }
      if(p.type==="message.new"){
        const ch = channels.find(c=>c.id===currentChannelId);
        ch.messages.push(p.message);
        renderMessages();
      }
    });

    // -----------------------------------
    // Channel actions / search
    // -----------------------------------
    $("#channelSearch").addEventListener("input", e=> renderChannels(e.target.value));
    $("#globalSearch").addEventListener("keydown", e=>{
      if((e.metaKey || e.ctrlKey) && e.key.toLowerCase()==="k"){ e.preventDefault(); $("#globalSearch").focus(); }
    });
    $("#addChannel").onclick = ()=>{
      const name = prompt("Channel name (with #):", "#new-channel");
      if(!name) return;
      const id = "c_" + crypto.randomUUID().slice(0,6);
      channels.unshift({ id, name, members:[me.id], online:[me.id], pinned:false, muted:false, messages:[] });
      renderChannels($("#channelSearch").value);
    };
    $("#newChat").onclick = ()=>{
      const uname = prompt("Start DM with who? (Amy/Max/Lee)");
      const u = users.find(x=> x.name.toLowerCase()===String(uname||"").toLowerCase());
      if(!u) return alert("User not found");
      const id = "dm_" + crypto.randomUUID().slice(0,6);
      channels.unshift({ id, name:`@${u.name}`, members:[me.id,u.id], online:[me.id], pinned:false, muted:false, messages:[] });
      currentChannelId = id;
      loadChannel(id);
      renderChannels($("#channelSearch").value);
    };

    // -----------------------------------
    // Utilities
    // -----------------------------------
    function insertAtCursor(el, text){
      const start = el.selectionStart, end = el.selectionEnd;
      el.value = el.value.slice(0,start) + text + el.value.slice(end);
      el.selectionStart = el.selectionEnd = start + text.length;
      el.dispatchEvent(new Event("input"));
    }
    function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }

    // -----------------------------------
    // Bootstrap
    // -----------------------------------
    function seed(){
      const ch = channels.find(c=>c.id===currentChannelId);
      ch.messages.push(
        { id:crypto.randomUUID(), userId:"u_amy", text:"Welcome to the channel! 🎉", createdAt:Date.now()-1000*60*60*24, attachments:[], reactions:{"🎉":["u_me","u_max"]}, thread:[] },
        { id:crypto.randomUUID(), userId:"u_me", text:"Hey team — I’ll share the HS codes list shortly.", createdAt:Date.now()-1000*60*50, attachments:[], reactions:{}, thread:[] },
        { id:crypto.randomUUID(), userId:"u_max", text:"Anyone knows the ETA for PO-1021?", createdAt:Date.now()-1000*60*30, attachments:[], reactions:{}, thread:[] },
      );
    }

    seed();
    renderChannels();
    loadChannel(currentChannelId);
    realtime.subscribe(currentChannelId, ev=> events.emit(ev));
  </script>
</body>
</html>

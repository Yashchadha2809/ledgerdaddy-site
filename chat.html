<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>Ask in Chat ‚Äì Ledgerdaddy</title>
  <meta name="theme-color" content="#1A237E" />
  <link rel="preconnect" href="https://images.unsplash.com" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors:{ indigoDeep:"#1A237E", emerald:"#2E7D32", cyanBright:"#00BCD4", accentOrange:"#FF7043" },
          boxShadow:{ lift:"0 14px 34px rgba(0,0,0,.12)" },
          height: { 'screen-dvh': 'calc(var(--vh, 1vh) * 100)' }
        }
      }
    }
  </script>
  <style>
    /* Prevent horizontal shake; make layout fully fluid */
    html, body {
      height: 100%;
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
    }

    /* Mobile viewport height fix (set in JS) */
    .fade-in{animation:fade .15s ease-out}
    @keyframes fade{from{opacity:.5;transform:translateY(2px)}to{opacity:1;transform:none}}
    .typing-dot{animation:pulse 1s infinite ease-in-out}
    .typing-dot:nth-child(2){animation-delay:.15s}
    .typing-dot:nth-child(3){animation-delay:.3s}
    @keyframes pulse{0%,80%,100%{opacity:.25}40%{opacity:1}}

    .card{transition:transform .12s ease, box-shadow .2s ease}
    .card:hover{transform:translateY(-2px); box-shadow:0 14px 34px rgba(0,0,0,.14)}
    .hero-img{background:url('https://images.unsplash.com/photo-1586521995568-39ef16c6934d?q=80&w=1920&auto=format&fit=crop') center/cover no-repeat;}
    pre{background:#0f172a; color:#e5e7eb; padding:12px; border-radius:10px; overflow:auto}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}

    /* Upload previews */
    .thumb{width:56px;height:56px;border-radius:10px;object-fit:cover;border:1px solid #e5e7eb}
    .file-pill{border:1px solid #e5e7eb;border-radius:10px;padding:.4rem .6rem;font-size:12px;display:flex;align-items:center;gap:.5rem;background:#fff}
    .drop-target{outline:2px dashed #00BCD4; outline-offset:4px}

    .btn{display:inline-flex;align-items:center;gap:.55rem;padding:.56rem .9rem;border-radius:12px;font-weight:600}
    .btn-emerald{background:#2E7D32;color:#fff}
    .btn-emerald:hover{filter:brightness(1.03)}
    .btn-ghost{border:1px solid #e5e7eb;background:transparent}
    .chip{font-size:12px;border:1px solid #e5e7eb;border-radius:999px;padding:.3rem .6rem;background:#fff}

    /* Drawer transitions */
    .drawer-enter { transform: translateX(-100%); opacity: .6; }
    .drawer-enter-active { transform: translateX(0); opacity: 1; transition: transform .18s ease, opacity .18s ease; }
    .drawer-exit { transform: translateX(0); opacity: 1; }
    .drawer-exit-active { transform: translateX(-100%); opacity: .0; transition: transform .18s ease, opacity .18s ease; }

    /* Bubbles must be fluid + wrap safely */
    .bubble, .file-pill { max-width: 100% !important; word-wrap: break-word; word-break: break-word; overflow-wrap: anywhere; }
    .bubble-content { max-width: 100%; }

    /* iOS tap highlight */
    * { -webkit-tap-highlight-color: rgba(0,0,0,0.05); }

    /* Mobile overrides to avoid ‚Äúwidth shake‚Äù */
    @media (max-width: 768px) {
      #drawer {
        width: 100% !important; /* full width on mobile */
        max-width: none !important;
      }
      #messages {
        padding-left: .5rem;
        padding-right: .5rem;
      }
      /* Limit filename text to viewport width, not fixed pixels */
      .name-wrap {
        max-width: 52vw; /* fluid cap for small screens */
      }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 h-screen-dvh flex flex-col">

  <!-- Topbar -->
  <header class="fixed top-0 inset-x-0 z-50 border-b border-gray-200 bg-white/90 backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <button id="openDrawer" class="md:hidden inline-flex items-center justify-center h-9 w-9 rounded-lg border border-gray-200" aria-label="Open conversations">
        ‚ò∞
      </button>
      <a href="./dashboard.html" class="flex items-center gap-2" aria-label="Home">
        <span class="grid h-9 w-9 place-items-center rounded-xl bg-gradient-to-tr from-cyanBright to-emerald text-white font-extrabold shadow">‚óÜ</span>
        <span class="text-lg md:text-xl font-bold text-indigoDeep">Ledgerdaddy</span>
        <span class="ml-2 hidden sm:inline-flex text-[11px] px-2 py-0.5 rounded-full border border-cyanBright/40 text-cyanBright">AI Customs</span>
      </a>
      <nav class="hidden md:flex items-center gap-6 text-sm font-medium">
        <a href="./marketplace.html" class="hover:text-cyanBright">Marketplace</a>
        <a href="./calculator.html" class="hover:text-cyanBright">Calculator</a>
        <a href="./hs-finder.html" class="hover:text-cyanBright">HS Finder</a>
        <a href="./dashboard.html" class="hover:text-cyanBright">Dashboard</a>
      </nav>
      <div class="hidden md:flex items-center gap-2">
        <a href="./log-in.html" class="border px-3 py-1.5 rounded-lg text-sm">Log in</a>
        <a href="./personal-sign-up.html" class="bg-emerald text-white px-3 py-1.5 rounded-lg text-sm hover:opacity-95">Sign up</a>
      </div>
      <a href="./personal-sign-up.html" class="md:hidden bg-emerald text-white px-3 py-1.5 rounded-lg text-sm">Start</a>
    </div>
  </header>

  <!-- Drawer (mobile conversations) -->
  <div id="drawerBackdrop" class="fixed inset-0 z-[60] bg-black/30 hidden md:hidden"></div>
  <aside id="drawer"
    class="fixed left-0 top-0 bottom-0 z-[61] w-full bg-white border-r border-gray-200 p-3 md:hidden drawer-enter hidden">
    <div class="flex items-center justify-between">
      <strong>Conversations</strong>
      <div class="flex items-center gap-2">
        <button id="newChat_m" class="text-xs border rounded px-2 py-1">New</button>
        <button id="closeDrawer" class="text-xs border rounded px-2 py-1">Close</button>
      </div>
    </div>
    <ul id="chatList_m" class="mt-3 grid gap-1 text-sm overflow-auto" style="max-height: calc(var(--vh, 1vh) * 100 - 140px)"></ul>
    <div class="mt-3 grid gap-2 text-sm">
      <a class="border px-2 py-1 rounded text-center" href="./hs-finder.html">Open HS Finder</a>
      <a class="border px-2 py-1 rounded text-center" href="./calculator.html">Open Calculator</a>
      <button id="exportBtn_m" class="border px-2 py-1 rounded">Export current</button>
      <button id="clearAll_m" class="text-red-600 border border-red-200 px-2 py-1 rounded">Clear all</button>
    </div>
  </aside>

  <!-- Hero (slim on mobile) -->
  <section class="pt-[56px] md:pt-[76px] w-full">
    <div class="hero-img">
      <div class="backdrop-brightness-100 md:bg-gradient-to-r md:from-indigoDeep/70 md:to-cyanBright/60">
        <div class="max-w-6xl mx-auto px-4 py-4 md:py-8 text-indigoDeep md:text-white">
          <h1 class="text-xl md:text-4xl font-extrabold">Ask in Chat</h1>
          <p class="mt-1 md:mt-2 text-indigoDeep/80 md:text-white/95 text-sm md:text-base">
            Chat assistant for HS, duties & valuation. Attach images, PDFs, spreadsheets for context.
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- Chat layout -->
  <main class="max-w-7xl mx-auto px-2 sm:px-4 pb-20 md:pb-28 grid md:grid-cols-[280px,1fr] gap-4 -mt-2 md:-mt-4 flex-1 w-full">
    <!-- Sidebar (desktop) -->
    <aside class="hidden md:block bg-white border border-gray-200 rounded-2xl shadow p-3 h-fit md:sticky md:top-[92px] w-full">
      <div class="flex items-center justify-between">
        <strong>Conversations</strong>
        <button id="newChat" class="text-xs border rounded px-2 py-1">New chat</button>
      </div>
      <ul id="chatList" class="mt-3 grid gap-1 text-sm max-h-[50vh] overflow-auto"></ul>
      <div class="mt-3 grid gap-2 text-sm">
        <a class="border px-2 py-1 rounded text-center" href="./hs-finder.html">Open HS Finder</a>
        <a class="border px-2 py-1 rounded text-center" href="./calculator.html">Open Calculator</a>
        <button id="exportBtn" class="border px-2 py-1 rounded">Export current chat</button>
        <button id="clearAll" class="text-red-600 border border-red-200 px-2 py-1 rounded">Clear all</button>
      </div>
    </aside>

    <!-- Conversation -->
    <section class="bg-white border border-gray-200 rounded-2xl shadow flex flex-col min-h-[60vh] w/full">
      <!-- Stream -->
      <div id="messages" class="flex-1 overflow-auto p-3 md:p-4 space-y-3 md:space-y-4 w-full">
        <div class="fade-in rounded-xl bg-gray-50 p-3 md:p-4 bubble w-full">
          <div class="text-xs md:text-sm text-gray-600">Assistant</div>
          <div class="mt-1 whitespace-pre-wrap text-[14px] leading-relaxed bubble-content">
            Hey! I‚Äôm your customs agent. Ask me about HS codes, duties, or docs. You can also attach files (images, PDFs, spreadsheets).
            <div class="mt-3 flex flex-wrap gap-2">
              <button class="chip demo-btn" data-q="Estimate duty for HS 851713 (IN) CIF 100000">Estimate Duty</button>
              <button class="chip demo-btn" data-q="Find HS code for wireless earbuds in India">Find HS Code</button>
              <button class="chip demo-btn" data-q="Documents to import wooden furniture into EU">Docs Checklist</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Composer -->
      <div class="border-t p-2 md:p-3 sticky bottom-0 bg-white w-full">
        <!-- Attachment previews -->
        <div id="attachRow" class="hidden mb-2 flex items-center gap-2 flex-wrap"></div>

        <form id="composer" class="flex items-end gap-2 md:gap-3 w-full">
          <!-- Attach -->
          <input id="fileInput" type="file" class="hidden" multiple
            accept="image/*,.pdf,.csv,.txt,.json,.md,.doc,.docx,.xls,.xlsx,.ppt,.pptx" />
          <button type="button" id="attachBtn" title="Attach files"
            class="btn btn-ghost h-10 md:h-11 min-w-[44px]" aria-label="Attach files">üìé</button>

          <!-- Text -->
          <textarea id="chatInput" rows="1" placeholder="Message Ledgerdaddy‚Ä¶"
            class="flex-1 border rounded-xl px-3 py-2 md:py-2.5 text-[15px] md:text-[15px] resize-none max-h-40 focus:outline-none focus:ring-2 focus:ring-cyanBright/40 w-full"
            inputmode="text" enterkeyhint="send"></textarea>

          <!-- Send -->
          <button id="sendBtn" class="btn btn-emerald h-10 md:h-11 px-4 md:px-5">Send</button>
        </form>

        <div class="mt-2 flex items-center justify-between w-full">
          <div class="text-[11px] text-gray-500 hidden md:block">Enter to send ‚Ä¢ Shift+Enter for new line ‚Ä¢ Drag & drop files (desktop)</div>
          <div class="md:hidden text-[11px] text-gray-500">Tap üìé to attach ‚Ä¢ Enter to send</div>
          <button id="toBottom" class="chip hidden">Scroll to bottom</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Mobile bottom bar (quick actions) -->
  <nav class="md:hidden fixed bottom-0 inset-x-0 z-40 bg-white border-t border-gray-200 w-full">
    <div class="max-w-7xl mx-auto px-3 py-2 grid grid-cols-3 gap-2 w-full">
      <button id="fabNew" class="w-full border rounded-lg py-2 text-sm">+ New</button>
      <button id="fabAttach" class="w-full border rounded-lg py-2 text-sm">üìé Upload</button>
      <button id="fabDown" class="w-full border rounded-lg py-2 text-sm">‚¨áÔ∏é Bottom</button>
    </div>
  </nav>

  <!-- Toast -->
  <div id="toast" class="hidden fixed bottom-20 right-4 md:bottom-6 md:right-6 bg-gray-900 text-white text-sm px-3 py-2 rounded-lg shadow"></div>

  <footer class="text-center text-xs text-gray-500 my-14 md:my-8 w-full">
    ¬© <span id="year"></span> Ledgerdaddy
  </footer>

  <script>
    // ===== Mobile viewport fix (prevents width/height jumps) =====
    function setVH(){
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    setVH(); window.addEventListener('resize', setVH);

    // ===== Backend URL (auto same-origin; override with window.__LD_API_BASE__) =====
    const API_BASE = (window.__LD_API_BASE__ ?? '').toString();
    const $  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    $('#year').textContent = new Date().getFullYear();
    const toast = (msg) => { const t = $('#toast'); t.textContent = msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 1600); };
    const uid = () => Math.random().toString(36).slice(2)+Date.now().toString(36);

    function join(base, path){
      if(!base) return path; // same-origin
      return base.replace(/\/+$/,'') + path;
    }

    function getSessionId(){
      const k="ld_chat_session_id";
      let v = localStorage.getItem(k);
      if(!v){ v=(crypto?.randomUUID?.() || `sess_${uid()}`); localStorage.setItem(k, v); }
      return v;
    }
    const SESSION_ID = getSessionId();

    // ===== Storage (threads) =====
    const STORE_KEY='ld_chat_threads_v1';
    let threads = JSON.parse(localStorage.getItem(STORE_KEY) || '[]');
    let currentId = threads[0]?.id || null;
    function saveThreads(){ localStorage.setItem(STORE_KEY, JSON.stringify(threads)); }
    function newThread(){
      const id = uid();
      const t = { id, title: 'New chat', messages: [] };
      threads.unshift(t);
      currentId = id;
      saveThreads(); renderSidebar(); renderMessages(); renderMobileList();
    }
    function getCurrent(){ return threads.find(t=>t.id===currentId); }
    function setTitleFromFirstUserMessage(thread){
      const first = thread.messages.find(m=>m.role==='user');
      if(first){ thread.title = (first.text || 'Conversation').slice(0, 50); }
    }

    // ===== Sidebar (desktop) =====
    function renderSidebar(){
      const list = $('#chatList');
      if(!list) return;
      if(!threads.length){
        list.innerHTML = '<li class="text-gray-500 text-xs p-2 rounded bg-gray-50">No conversations yet</li>'; return;
      }
      list.innerHTML = threads.map(t=>`
        <li>
          <button data-id="${t.id}"
            class="w-full text-left px-2 py-2 rounded hover:bg-gray-50 ${t.id===currentId?'bg-gray-100':''}">
            <div class="truncate">${t.title || 'Conversation'}</div>
            <div class="text-[11px] text-gray-500">${(t.messages?.length||0)} messages</div>
          </button>
        </li>
      `).join('');
      list.querySelectorAll('button[data-id]').forEach(btn=>{
        btn.onclick = ()=>{ currentId = btn.getAttribute('data-id'); renderSidebar(); renderMessages(); renderMobileList(); closeDrawer(); };
      });
    }

    // ===== Sidebar (mobile drawer) =====
    const drawer = $('#drawer'), backdrop = $('#drawerBackdrop');
    function openDrawer(){
      drawer.classList.remove('hidden','drawer-exit','drawer-exit-active');
      backdrop.classList.remove('hidden');
      drawer.classList.add('drawer-enter-active');
      requestAnimationFrame(()=> drawer.classList.remove('drawer-enter','drawer-enter-active'));
    }
    function closeDrawer(){
      drawer.classList.add('drawer-exit-active');
      setTimeout(()=>{
        drawer.classList.add('hidden','drawer-enter');
        drawer.classList.remove('drawer-exit-active');
        backdrop.classList.add('hidden');
      }, 180);
    }
    $('#openDrawer').addEventListener('click', openDrawer);
    $('#closeDrawer').addEventListener('click', closeDrawer);
    backdrop.addEventListener('click', closeDrawer);

    function renderMobileList(){
      const list = $('#chatList_m');
      if(!list) return;
      if(!threads.length){
        list.innerHTML = '<li class="text-gray-500 text-xs p-2 rounded bg-gray-50">No conversations yet</li>'; return;
      }
      list.innerHTML = threads.map(t=>`
        <li>
          <button data-id="${t.id}"
            class="w-full text-left px-2 py-2 rounded hover:bg-gray-50 ${t.id===currentId?'bg-gray-100':''}">
            <div class="truncate">${t.title || 'Conversation'}</div>
            <div class="text-[11px] text-gray-500">${(t.messages?.length||0)} messages</div>
          </button>
        </li>
      `).join('');
      list.querySelectorAll('button[data-id]').forEach(btn=>{
        btn.onclick = ()=>{ currentId = btn.getAttribute('data-id'); renderSidebar(); renderMessages(); renderMobileList(); closeDrawer(); };
      });
    }

    // ===== Markdown-lite =====
    function mdLite(text){
      let out = (text || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      out = out.replace(/```([\s\S]*?)```/g, (_,code)=>`<pre><code>${code}</code></pre>`);
      out = out.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      out = out.replace(/`([^`]+)`/g, '<code class="bg-gray-100 px-1 py-0.5 rounded text-[90%]">$1</code>');
      out = out.replace(/\n\n/g, '<br/><br/>');
      return out;
    }

    // ===== Attachments =====
    const MAX_FILES = 10;
    const MAX_MB = 25; // per file
    const attachBtn = $('#attachBtn');
    const fileInput = $('#fileInput');
    const attachRow = $('#attachRow');
    const msgWrap   = $('#messages');

    let pendingFiles = []; // [{file, id, url}]

    attachBtn.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', (e)=> addPendingFiles([...e.target.files]));
    // Mobile bottom bar ‚Äì Upload shortcut
    $('#fabAttach').addEventListener('click', ()=> fileInput.click());

    // Drag & drop (desktop)
    ;['dragenter','dragover'].forEach(ev=>{
      document.addEventListener(ev, (e)=>{ e.preventDefault(); msgWrap.classList.add('drop-target'); });
    });
    ;['dragleave','drop'].forEach(ev=>{
      document.addEventListener(ev, (e)=>{ e.preventDefault(); msgWrap.classList.remove('drop-target'); });
    });
    document.addEventListener('drop', (e)=>{
      const files = [...(e.dataTransfer?.files||[])];
      if(files.length) addPendingFiles(files);
    });

    function addPendingFiles(files){
      const all = [...pendingFiles];
      for(const f of files){
        if(all.length >= MAX_FILES){ toast('Max 10 files'); break; }
        if(f.size > MAX_MB*1024*1024){ toast(`${f.name} is over ${MAX_MB}MB`); continue; }
        all.push({ file:f, id:uid(), url: URL.createObjectURL(f) });
      }
      pendingFiles = all;
      renderPending();
    }
    function removePending(id){
      pendingFiles = pendingFiles.filter(p=>p.id!==id);
      renderPending();
    }
    function fileIcon(name){
      const ext=(name.split('.').pop()||'').toLowerCase();
      if(['png','jpg','jpeg','gif','webp','heic','heif','bmp'].includes(ext)) return 'üñºÔ∏è';
      if(['pdf'].includes(ext)) return 'üìÑ';
      if(['csv','xls','xlsx'].includes(ext)) return 'üìä';
      if(['doc','docx'].includes(ext)) return 'üìù';
      if(['ppt','pptx'].includes(ext)) return 'üìΩÔ∏è';
      if(['txt','json','md'].includes(ext)) return 'üìÉ';
      return 'üìé';
    }
    function renderPending(){
      if(!pendingFiles.length){ attachRow.classList.add('hidden'); attachRow.innerHTML=''; return; }
      attachRow.classList.remove('hidden');
      attachRow.innerHTML = pendingFiles.map(p=>{
        const isImg = p.file.type.startsWith('image/');
        const size = (p.file.size/1024/1024).toFixed(1)+'MB';
        return isImg
          ? `<div class="relative">
               <img src="${p.url}" class="thumb" alt="${p.file.name}"/>
               <button title="Remove" class="absolute -top-2 -right-2 bg-white border border-gray-200 rounded-full w-6 h-6 text-xs"
                 onclick="removePending('${p.id}')">√ó</button>
             </div>`
          : `<div class="file-pill bubble w-full">
               <span>${fileIcon(p.file.name)}</span>
               <span class="truncate name-wrap">${p.file.name}</span>
               <span class="text-gray-500">${size}</span>
               <button title="Remove" class="ml-1 border border-gray-200 rounded px-1 text-[11px]" onclick="removePending('${p.id}')">√ó</button>
             </div>`;
      }).join('');
      window.removePending = removePending;
    }
    async function uploadFiles(files){
      if(!files.length) return [];
      const form = new FormData();
      files.forEach(f => form.append('files', f.file, f.file.name));
      try{
        const res = await fetch(join(API_BASE, '/api/upload'), { method:'POST', body:form, cache:'no-store' });
        if(!res.ok) throw new Error('Upload failed');
        const data = await res.json();
        const list = Array.isArray(data) ? data : (data.files || [data]);
        return list.map((x,i)=>({
          url: x.url || files[i].url,
          name: x.name || files[i].file.name,
          type: x.type || files[i].file.type,
          size: x.size || files[i].file.size
        }));
      }catch(e){
        toast('Upload error: ' + (e.message||'unknown'));
        return files.map(p=>({ url:p.url, name:p.file.name, type:p.file.type, size:p.file.size }));
      }
    }
    function attachBlock(attachments=[]){
      if(!attachments.length) return '';
      return `
        <div class="mt-2 flex flex-wrap gap-2 w-full">
          ${attachments.map(a=>{
            const isImg = /^image\//.test(a.type);
            return isImg
              ? `<a href="${a.url}" target="_blank" class="inline-flex items-center gap-2 bubble w-full" title="${a.name||'image'}">
                   <img src="${a.url}" alt="${a.name||'image'}" class="thumb"/>
                   <span class="text-[12px] text-gray-600 truncate name-wrap">${a.name||'image'}</span>
                 </a>`
              : `<a href="${a.url}" target="_blank" class="file-pill bubble w-full" title="${a.name||'file'}">
                   <span>${fileIcon(a.name||'file')}</span>
                   <span class="truncate name-wrap">${a.name||'file'}</span>
                   ${a.size ? `<span class="text-gray-500">${(a.size/1024/1024).toFixed(1)}MB</span>`:''}
                 </a>`;
          }).join('')}
        </div>
      `;
    }

    // ===== Messages =====
    function msgBubble(m){
      const { role, text, attachments } = m;
      const isUser = role==='user';
      const avatar = isUser ? 'üë§' : '‚óÜ';
      const bg = isUser ? 'bg-white' : 'bg-gray-50';
      return `
        <div class="fade-in rounded-xl ${bg} p-3 md:p-4 bubble w-full">
          <div class="text-[12px] md:text-sm text-gray-600 flex items-center gap-2 bubble-content">
            <span class="grid w-6 h-6 place-items-center rounded-full ${isUser?'bg-gray-200':'bg-indigoDeep text-white'} text-[12px]">${avatar}</span>
            <span class="truncate">${isUser?'You':'Assistant'}</span>
            <button class="ml-auto text-[11px] text-gray-500 copy-btn" data-copy="${encodeURIComponent(text||'')}">Copy</button>
          </div>
          ${attachments?.length ? attachBlock(attachments) : ''}
          <div class="mt-2 whitespace-pre-wrap leading-relaxed text-[14px] md:text-[15px] bubble-content">${mdLite(text||'')}</div>
        </div>
      `;
    }
    function typingBubble(){
      return `
        <div class="rounded-xl bg-gray-50 p-3 md:p-4 bubble w-full" id="typingBubble">
          <div class="text-xs md:text-sm text-gray-600 flex items-center gap-2">
            <span class="grid w-6 h-6 place-items-center rounded-full bg-indigoDeep text-white text-[12px]">‚óÜ</span>
            <span>Assistant</span>
          </div>
          <div class="mt-2 flex items-center gap-1">
            <span class="typing-dot w-2 h-2 rounded-full bg-gray-400"></span>
            <span class="typing-dot w-2 h-2 rounded-full bg-gray-400"></span>
            <span class="typing-dot w-2 h-2 rounded-full bg-gray-400"></span>
          </div>
        </div>
      `;
    }
    function renderMessages(){
      const wrap = $('#messages');
      const t = getCurrent();
      if(!t){ wrap.innerHTML = '<div class="p-4 text-gray-500">Start a new chat.</div>'; return; }
      wrap.innerHTML = t.messages.map(msgBubble).join('') || `
        <div class="rounded-xl bg-gray-50 p-3 md:p-4 bubble w-full">
          <div class="text-xs md:text-sm text-gray-600">Assistant</div>
          <div class="mt-1 bubble-content">How can I help today?</div>
        </div>
      `;
      $$('.copy-btn').forEach(b=>{
        b.onclick = async ()=>{
          try{ await navigator.clipboard.writeText(decodeURIComponent(b.getAttribute('data-copy'))); toast('Copied'); }
          catch{ toast('Copy failed'); }
        };
      });
      wrap.scrollTop = wrap.scrollHeight;
      toggleScrollBtn();
    }
    function addMessage(role, text, attachments=[]){
      const t = getCurrent(); if(!t) return;
      t.messages.push({ role, text, attachments, ts: Date.now() });
      if(t.title==='New chat'){ setTitleFromFirstUserMessage(t); }
      saveThreads(); renderSidebar(); renderMobileList(); renderMessages();
    }

    // ===== Send (JSON + Streaming support) =====
    const area = $('#chatInput');
    const form = $('#composer');
    const toBottomBtn = $('#toBottom');

    async function send(text){
      const trimmed = (text || '').trim();
      if(!trimmed && !pendingFiles.length) return;

      // Upload files first
      const uploaded = await uploadFiles(pendingFiles);
      pendingFiles.forEach(p=> URL.revokeObjectURL(p.url));
      pendingFiles = []; renderPending();

      addMessage('user', trimmed, uploaded);

      const wrap = $('#messages');
      wrap.insertAdjacentHTML('beforeend', typingBubble());
      wrap.scrollTop = wrap.scrollHeight;

      try {
        const res = await fetch(join(API_BASE, '/api/chat'), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message: trimmed,
            session_id: SESSION_ID,
            attachments: uploaded
          }),
          cache: "no-store"
        });

        const ct = (res.headers.get("content-type") || "").toLowerCase();

        // Remove typing bubble when real data arrives
        const tb = document.getElementById('typingBubble'); if(tb) tb.remove();

        if (ct.includes("text/event-stream") || ct.includes("text/plain") || ct.includes("application/octet-stream")) {
          // Streaming mode
          addMessage('assistant', ""); // create empty msg to append chunks
          const t = getCurrent();
          const msg = t.messages[t.messages.length - 1];
          const reader = res.body?.getReader();
          const decoder = new TextDecoder();
          let buffer = "";
          if (!reader) { addMessage('assistant', "‚ö†Ô∏è Streaming not supported by this browser."); return; }
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            buffer += decoder.decode(value, { stream: true });

            // Handle SSE: blocks separated by blank line
            const blocks = buffer.split(/\r?\n\r?\n/);
            buffer = blocks.pop() || "";
            for (const block of blocks) {
              const lines = block.split(/\r?\n/).filter(Boolean);
              for (const line of lines) {
                const payload = line.replace(/^data:\s?/, "");
                try {
                  const obj = JSON.parse(payload);
                  const delta = obj.delta ?? obj.message ?? obj.content ?? "";
                  if (delta) { msg.text = (msg.text || "") + delta; saveThreads(); renderMessages(); }
                } catch {
                  msg.text = (msg.text || "") + payload;
                  saveThreads(); renderMessages();
                }
              }
            }
          }
          // Flush trailing text
          if (buffer.trim()) {
            try {
              const obj = JSON.parse(buffer);
              const delta = obj.delta ?? obj.message ?? obj.content ?? buffer;
              msg.text = (msg.text || "") + delta;
            } catch {
              msg.text = (msg.text || "") + buffer;
            }
            saveThreads(); renderMessages();
          }
          return;
        }

        if (ct.includes("application/json")) {
          const data = await res.json();
          if (res.ok && data.reply){
            addMessage('assistant', data.reply);
          } else {
            addMessage('assistant', "‚ö†Ô∏è Error: " + (data.error || `API ${res.status}`));
          }
          return;
        }

        // Any other content type: show text as-is
        const textResp = await res.text();
        addMessage('assistant', textResp || `‚ö†Ô∏è Unexpected response (HTTP ${res.status})`);
      } catch (err) {
        const tb2 = document.getElementById('typingBubble'); if(tb2) tb2.remove();
        addMessage('assistant', "‚ö†Ô∏è Network error: " + err.message);
      }
    }

    // Textarea behaviours (mobile friendly)
    area.addEventListener('input', ()=>{
      area.style.height = 'auto';
      area.style.height = Math.min(area.scrollHeight, 160) + 'px';
    });
    area.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && !e.shiftKey){
        e.preventDefault();
        send(area.value);
        area.value=''; area.style.height='auto';
      }
    });
    form.addEventListener('submit', (e)=>{ e.preventDefault(); send(area.value); area.value=''; area.style.height='auto'; });

    // Quick chips
    $$('.demo-btn').forEach(b=> b.onclick = ()=>{
      area.value = b.getAttribute('data-q');
      area.dispatchEvent(new Event('input'));
      area.focus();
    });

    // Scroll helpers
    function toggleScrollBtn(){
      const nearBottom = (msgWrap.scrollHeight - msgWrap.scrollTop - msgWrap.clientHeight) < 140;
      if(nearBottom) toBottomBtn.classList.add('hidden'); else toBottomBtn.classList.remove('hidden');
    }
    const msgWrap = $('#messages');
    msgWrap.addEventListener('scroll', toggleScrollBtn);
    $('#fabDown').addEventListener('click', ()=>{ msgWrap.scrollTop = msgWrap.scrollHeight; });
    $('#fabNew').addEventListener('click', ()=>{ newThread(); openDrawer(); });
    const toBottomBtn = $('#toBottom');
    toBottomBtn.addEventListener('click', ()=>{ msgWrap.scrollTop = msgWrap.scrollHeight; toggleScrollBtn(); });

    // Sidebar actions (desktop)
    $('#newChat')?.addEventListener('click', ()=> newThread());
    $('#exportBtn')?.addEventListener('click', ()=>{
      const t = getCurrent(); if(!t) return toast('No chat');
      const blob = new Blob([JSON.stringify(t, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = (t.title||'chat') + '.json';
      a.click(); URL.revokeObjectURL(a.href);
    });
    $('#clearAll')?.addEventListener('click', ()=>{
      if(confirm('Delete all conversations?')){
        threads=[]; currentId=null; saveThreads(); renderSidebar(); renderMobileList(); renderMessages(); toast('Cleared');
      }
    });

    // Drawer actions (mobile)
    $('#newChat_m').addEventListener('click', ()=> newThread());
    $('#exportBtn_m').addEventListener('click', ()=>{
      const t = getCurrent(); if(!t) return toast('No chat');
      const blob = new Blob([JSON.stringify(t, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = (t.title||'chat') + '.json';
      a.click(); URL.revokeObjectURL(a.href);
    });
    $('#clearAll_m').addEventListener('click', ()=>{
      if(confirm('Delete all conversations?')){
        threads=[]; currentId=null; saveThreads(); renderSidebar(); renderMobileList(); renderMessages(); toast('Cleared');
      }
    });

    // ===== Init =====
    if(!threads.length){ newThread(); } else { renderSidebar(); renderMobileList(); renderMessages(); }
  </script>
</body>
</html>

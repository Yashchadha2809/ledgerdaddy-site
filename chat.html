<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>Ask in Chat – Chadaddy</title>
  <meta name="theme-color" content="#111827" />
  <link rel="preconnect" href="https://images.unsplash.com" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors:{
            brandPrimary:"#111827",
            brandAccent:"#2563EB",
            brandSoft:"#EFF6FF",
            brandBorder:"#E5E7EB",
            brandMuted:"#6B7280",
            brandBg:"#F9FAFB"
          },
          boxShadow:{ lift:"0 14px 34px rgba(17,24,39,.06)" },
          height: { 'screen-dvh': 'calc(var(--vh, 1vh) * 100)' },
          backgroundImage:{
            "soft-gradient":"linear-gradient(135deg, #EFF6FF 0%, #FFFFFF 100%)"
          }
        }
      }
    }
  </script>
  <style>
    html, body { height: 100%; width: 100%; overflow-x: hidden; }
    .fade-in{animation:fade .15s ease-out}
    @keyframes fade{from{opacity:.5;transform:translateY(2px)}to{opacity:1;transform:none}}
    .typing-dot{animation:pulse 1s infinite ease-in-out}
    .typing-dot:nth-child(2){animation-delay:.15s}
    .typing-dot:nth-child(3){animation-delay:.3s}
    @keyframes pulse{0%,80%,100%{opacity:.25}40%{opacity:1}}
    .card{transition:transform .12s ease, box-shadow .2s ease}
    .hero-img{background:url('https://images.unsplash.com/photo-1586521995568-39ef16c6934d?q=80&w=1920&auto=format&fit=crop') center/cover no-repeat;}
    pre{background:#0f172a; color:#e5e7eb; padding:12px; border-radius:10px; overflow:auto}
    code{font-family:ui-monospace,monospace}
    .btn{display:inline-flex;align-items:center;gap:.55rem;padding:.56rem .9rem;border-radius:12px;font-weight:600}
    .btn-accent{background:#2563EB;color:#fff}
    .btn-accent:hover{filter:brightness(1.03)}
    .chip{font-size:12px;border:1px solid #E5E7EB;border-radius:999px;padding:.3rem .6rem;background:#fff}
  </style>
</head>
<body class="bg-brandBg text-brandPrimary h-screen-dvh flex flex-col">

  <!-- Topbar -->
  <header class="fixed top-0 inset-x-0 z-50 border-b border-brandBorder bg-white/90 backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="./dashboard.html" class="flex items-center gap-2" aria-label="Home">
        <span class="grid h-9 w-9 place-items-center rounded-xl bg-soft-gradient text-brandPrimary font-extrabold shadow">◆</span>
        <span class="text-lg md:text-xl font-bold">Chadaddy</span>
        <span class="ml-2 hidden sm:inline-flex text-[11px] px-2 py-0.5 rounded-full border border-brandAccent/40 text-brandAccent">AI Customs</span>
      </a>
      <nav class="hidden md:flex items-center gap-6 text-sm font-medium">
        <a href="./marketplace.html" class="hover:text-brandAccent">Marketplace</a>
        <a href="./calculator.html" class="hover:text-brandAccent">Calculator</a>
        <a href="./hs-finder.html" class="hover:text-brandAccent">HS Finder</a>
        <a href="./dashboard.html" class="hover:text-brandAccent">Dashboard</a>
      </nav>
      <!-- Session-aware controls -->
      <div id="userControls" class="flex items-center gap-2 text-sm"></div>
    </div>
  </header>

  <!-- Hero -->
  <section class="pt-[56px] md:pt-[76px] w-full">
    <div class="hero-img">
      <div class="backdrop-brightness-100 md:bg-gradient-to-r md:from-brandPrimary/70 md:to-brandAccent/60">
        <div class="max-w-6xl mx-auto px-4 py-4 md:py-8 text-brandPrimary md:text-white">
          <h1 class="text-xl md:text-4xl font-extrabold">Ask in Chat</h1>
          <p class="mt-1 md:mt-2 text-brandPrimary/80 md:text-white/95 text-sm md:text-base">
            Chat with the AI customs assistant. Works in demo mode without login. Your session will persist if logged in.
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- Chat layout -->
  <main class="max-w-7xl mx-auto px-2 sm:px-4 pb-20 md:pb-28 grid md:grid-cols-[280px,1fr] gap-4 -mt-2 md:-mt-4 flex-1 w-full">
    <!-- Sidebar (desktop) -->
    <aside class="hidden md:block bg-white border border-brandBorder rounded-2xl shadow p-3 h-fit md:sticky md:top-[92px] w-full">
      <strong>Conversations</strong>
      <ul id="chatList" class="mt-3 grid gap-1 text-sm max-h-[50vh] overflow-auto"></ul>
    </aside>

    <!-- Conversation -->
    <section class="bg-white border border-brandBorder rounded-2xl shadow flex flex-col min-h-[60vh] w-full">
      <div id="messages" class="flex-1 overflow-auto p-3 space-y-3">
        <div class="fade-in rounded-xl bg-brandSoft p-3 bubble w-full">
          <div class="text-xs text-brandMuted">Assistant</div>
          <div class="mt-1 whitespace-pre-wrap text-[14px] leading-relaxed bubble-content">
            👋 Hey! You can start chatting right away. No login required for basic queries.  
            <div class="mt-3 flex flex-wrap gap-2">
              <button class="chip demo-btn" data-q="Estimate duty for HS 851713 (IN) CIF 100000">Estimate Duty</button>
              <button class="chip demo-btn" data-q="Find HS code for wireless earbuds in India">Find HS Code</button>
              <button class="chip demo-btn" data-q="Docs needed to import wooden furniture into EU">Docs Checklist</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Composer -->
      <div class="border-t border-brandBorder p-2 sticky bottom-0 bg-white w-full">
        <form id="composer" class="flex items-end gap-2 w-full">
          <textarea id="chatInput" rows="1" placeholder="Message Chadaddy…"
            class="flex-1 border border-brandBorder rounded-xl px-3 py-2 text-[15px] resize-none max-h-40 focus:outline-none focus:ring-2 focus:ring-brandAccent/40 w-full"></textarea>
          <button id="sendBtn" class="btn btn-accent h-10 px-4">Send</button>
        </form>
      </div>
    </section>
  </main>

  <footer class="text-center text-xs text-brandMuted my-8 w-full">
    © <span id="year"></span> Chadaddy
  </footer>

  <script>
    // ===== Year =====
    document.getElementById('year').textContent = new Date().getFullYear();

    // ===== Session persistence =====
    const API_BASE = "https://chadaddy.onrender.com";
    async function checkSession(){
      try{
        const res = await fetch(`${API_BASE}/auth/session`, {
          credentials:"include",
          redirect:"manual"
        });
        if(res.status===200){
          const data = await res.json().catch(()=>null);
          if(data?.user){
            document.getElementById('userControls').innerHTML =
              `<span>Hi, ${data.user.name||'User'}</span>
               <a href="./dashboard.html" class="bg-brandAccent text-white px-3 py-1.5 rounded-lg">Dashboard</a>
               <a href="${API_BASE}/auth/logout" class="text-brandMuted ml-2">Log out</a>`;
            return;
          }
        }
      }catch(e){ console.warn("Session check failed", e); }
      // If not logged in → still allow demo
      document.getElementById('userControls').innerHTML =
        `<a href="./dashboard.html" class="bg-brandAccent text-white px-3 py-1.5 rounded-lg">Dashboard</a>`;
    }
    checkSession();

    // ===== Local session id (for continuity across tools) =====
    function getSessionId(){
      const key="ld_session_id";
      let v = localStorage.getItem(key);
      if(!v){ v = crypto.randomUUID?.() || 'sess_'+Date.now(); localStorage.setItem(key,v); }
      return v;
    }
    const SESSION_ID = getSessionId();

    // ===== Messages =====
    const messages = document.getElementById('messages');
    const chatInput = document.getElementById('chatInput');
    const form = document.getElementById('composer');

    function addMessage(role, text){
      const div = document.createElement('div');
      div.className = `fade-in rounded-xl ${role==='user'?'bg-white border border-brandBorder':'bg-brandSoft'} p-3 bubble w-full`;
      div.innerHTML = `<div class="text-xs text-brandMuted">${role==='user'?'You':'Assistant'}</div>
                       <div class="mt-1 whitespace-pre-wrap text-[14px]">${text}</div>`;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    async function sendMessage(text){
      if(!text.trim()) return;
      addMessage('user', text);
      chatInput.value="";

      const typing = document.createElement('div');
      typing.className = "fade-in rounded-xl bg-brandSoft p-3 bubble w-full";
      typing.innerHTML = `<div class="text-xs text-brandMuted">Assistant</div>
                          <div class="mt-1">...</div>`;
      messages.appendChild(typing);
      messages.scrollTop = messages.scrollHeight;

      try{
        const res = await fetch(`${API_BASE}/api/chat`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ message:text, session_id:SESSION_ID }),
          credentials:"include"
        });
        const data = await res.json().catch(()=>({ reply:"⚠️ Invalid response" }));
        typing.remove();
        addMessage('assistant', data.reply || "⚠️ No reply");
      }catch(err){
        typing.remove();
        addMessage('assistant', "⚠️ Network error: "+err.message);
      }
    }

    form.addEventListener('submit', e=>{
      e.preventDefault();
      sendMessage(chatInput.value);
    });

    document.querySelectorAll('.demo-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        chatInput.value = btn.dataset.q;
        sendMessage(btn.dataset.q);
      });
    });
  </script>
</body>
</html>

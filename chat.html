<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Learn Import Export Today ‚Äì Chadaddy</title>
  <meta name="theme-color" content="#111827" />
  <link rel="preconnect" href="https://images.unsplash.com" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brandPrimary:"#111827",
            brandAccent:"#2563EB",
            brandSoft:"#EFF6FF",
            brandBorder:"#E5E7EB",
            brandMuted:"#6B7280",
            brandBg:"#F9FAFB"
          },
          boxShadow: { lift:"0 14px 34px rgba(17,24,39,.06)" },
          height: { 'screen-dvh':'calc(var(--vh, 1vh) * 100)' },
          backgroundImage:{
            "soft-gradient":"linear-gradient(135deg, #EFF6FF 0%, #FFFFFF 100%)"
          }
        }
      }
    }
  </script>
  <style>
    html, body { height: 100%; width: 100%; overflow-x: hidden; }
    .fade-in{animation:fade .15s ease-out}
    @keyframes fade{from{opacity:.5;transform:translateY(2px)}to{opacity:1;transform:none}}
    .typing-dot{animation:pulse 1s infinite ease-in-out}
    .typing-dot:nth-child(2){animation-delay:.15s}
    .typing-dot:nth-child(3){animation-delay:.3s}
    @keyframes pulse{0%,80%,100%{opacity:.25}40%{opacity:1}}
    .bubble{word-wrap:break-word;overflow-wrap:break-word}
    pre{background:#0f172a;color:#e5e7eb;padding:12px;border-radius:10px;overflow:auto}
    code{font-family:ui-monospace,monospace}
    .btn{display:inline-flex;align-items:center;gap:.55rem;padding:.56rem .9rem;border-radius:12px;font-weight:600}
    .btn-accent{background:#2563EB;color:#fff}
    .btn-accent:hover{filter:brightness(1.03)}
    .chip{font-size:12px;border:1px solid #E5E7EB;border-radius:999px;padding:.3rem .6rem;background:#fff}
    .thumb{width:56px;height:56px;border-radius:10px;object-fit:cover;border:1px solid #E5E7EB}
    .file-pill{border:1px solid #E5E7EB;border-radius:10px;padding:.4rem .6rem;font-size:12px;display:flex;align-items:center;gap:.5rem;background:#fff}
    .drop-target{outline:2px dashed #2563EB; outline-offset:4px}
  </style>
</head>
<body class="bg-brandBg text-brandPrimary h-screen-dvh flex flex-col">

  <!-- Topbar -->
  <header class="fixed top-0 inset-x-0 z-50 border-b border-brandBorder bg-white/90 backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="./dashboard.html" class="flex items-center gap-2" aria-label="Home">
        <span class="grid h-9 w-9 place-items-center rounded-xl bg-soft-gradient text-brandPrimary font-extrabold shadow">‚óÜ</span>
        <span class="text-lg md:text-xl font-bold">Chadaddy</span>
        <span class="ml-2 hidden sm:inline-flex text-[11px] px-2 py-0.5 rounded-full border border-brandAccent/40 text-brandAccent">AI Customs</span>
      </a>
      <nav class="hidden md:flex items-center gap-6 text-sm font-medium">
        <a href="./marketplace.html" class="hover:text-brandAccent">Marketplace</a>
        <a href="./calculator.html" class="hover:text-brandAccent">Calculator</a>
        <a href="./hs-finder.html" class="hover:text-brandAccent">HS Finder</a>
        <a href="./chat.html" class="hover:text-brandAccent">Dashboard</a>
      </nav>
      <div id="userControls" class="flex items-center gap-2 text-sm"></div>
    </div>
  </header>

  <!-- Hero -->
  <section class="pt-[56px] md:pt-[76px] w-full">
    <div class="bg-gradient-to-r from-brandPrimary/70 to-brandAccent/60">
      <div class="max-w-6xl mx-auto px-4 py-6 md:py-10 text-white">
        <h1 class="text-2xl md:text-4xl font-extrabold">Ask in Chat</h1>
        <p class="mt-1 md:mt-2 text-white/90 text-sm md:text-base">
          Chat with your AI customs agent. Upload files, track threads, and continue across devices.
        </p>
      </div>
    </div>
  </section>

  <!-- Chat -->
  <main class="max-w-5xl mx-auto px-2 sm:px-4 pb-24 flex-1 w-full">
    <section class="bg-white border border-brandBorder rounded-2xl shadow flex flex-col min-h-[70vh] w-full">

      <!-- Messages -->
      <div id="messages" class="flex-1 overflow-auto p-4 space-y-4"></div>

      <!-- Composer -->
      <div class="border-t border-brandBorder p-3 bg-white w-full">
        <div id="attachRow" class="hidden mb-2 flex items-center gap-2 flex-wrap"></div>
        <form id="composer" class="flex items-end gap-2 w-full">
          <input id="fileInput" type="file" class="hidden" multiple accept="image/*,.pdf,.csv,.txt,.doc,.docx,.xls,.xlsx,.ppt,.pptx"/>
          <button type="button" id="attachBtn" title="Attach files" class="btn border border-brandBorder">üìé</button>
          <textarea id="chatInput" rows="1" placeholder="Message Chadaddy‚Ä¶" class="flex-1 border border-brandBorder rounded-xl px-3 py-2 text-[15px] resize-none max-h-40 focus:outline-none focus:ring-2 focus:ring-brandAccent/40 w-full"></textarea>
          <button id="sendBtn" class="btn btn-accent h-11 px-5">Send</button>
        </form>
        <p class="mt-2 text-[11px] text-brandMuted text-center">Enter to send ‚Ä¢ Shift+Enter for new line ‚Ä¢ üìé to attach files</p>
      </div>
    </section>
  </main>

  <footer class="text-center text-xs text-brandMuted my-8 w-full">
    ¬© <span id="year"></span> Chadaddy
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
    const API_BASE = "https://chadaddy.onrender.com";
    const CHAT_MODE = "learn"; // ‚Üê force LEARN prompt for this page

    // ===== Session ID =====
    function getSessionId(){
      const key="chadaddy_session_id";
      let v=localStorage.getItem(key);
      if(!v){ v = (crypto.randomUUID?.() || ('sess_'+Date.now())); localStorage.setItem(key,v); }
      return v;
    }
    const SESSION_ID = getSessionId();

    const messages=document.getElementById('messages');
    const chatInput=document.getElementById('chatInput');
    const form=document.getElementById('composer');
    const fileInput=document.getElementById('fileInput');
    const attachBtn=document.getElementById('attachBtn');
    const attachRow=document.getElementById('attachRow');
    let pendingFiles=[];

    function addMessage(role,text,attachments=[]){
      const div=document.createElement('div');
      div.className=`fade-in rounded-xl ${role==='user'?'bg-white border border-brandBorder':'bg-brandSoft'} p-4 bubble w-full`;
      let attachHTML="";
      if(attachments.length){
        attachHTML='<div class="mt-2 flex flex-wrap gap-2">'+attachments.map(a=>{
          return a.type.startsWith("image/")
            ? `<img src="${a.url}" alt="${a.name}" class="thumb"/>`
            : `<div class="file-pill"><span>üìÑ</span><span class="truncate">${a.name}</span></div>`;
        }).join("")+'</div>';
      }
      div.innerHTML=`
        <div class="flex items-center gap-2 text-xs text-brandMuted">
          <span class="w-6 h-6 grid place-items-center rounded-full ${role==='user'?'bg-brandBg':'bg-brandPrimary text-white'}">
            ${role==='user'?'üë§':'‚óÜ'}
          </span>
          ${role==='user'?'You':'Assistant'}
        </div>
        <div class="mt-2 whitespace-pre-wrap text-[14px] leading-relaxed">${text}</div>
        ${attachHTML}`;
      messages.appendChild(div);
      messages.scrollTop=messages.scrollHeight;
    }

    // ===== File handling =====
    attachBtn.addEventListener('click',()=>fileInput.click());
    fileInput.addEventListener('change',e=>{
      pendingFiles=[...e.target.files];
      renderPending();
    });

    function renderPending(){
      if(!pendingFiles.length){ attachRow.classList.add('hidden'); attachRow.innerHTML=""; return; }
      attachRow.classList.remove('hidden');
      attachRow.innerHTML=pendingFiles.map(f=>{
        return f.type.startsWith("image/")
          ? `<img src="${URL.createObjectURL(f)}" class="thumb" title="${f.name}"/>`
          : `<div class="file-pill"><span>üìÑ</span><span>${f.name}</span></div>`;
      }).join("");
    }

    async function uploadFiles(files){
      if(!files.length) return [];
      const fd=new FormData();
      files.forEach(f=>fd.append("files",f,f.name));
      try{
        const res=await fetch(`${API_BASE}/api/upload`,{method:"POST",body:fd});
        const data=await res.json();
        return (data.files||[]).map(x=>({url:x.url,name:x.name,type:x.type}));
      }catch(e){
        // fallback preview if upload API is unavailable
        return files.map(f=>({url:URL.createObjectURL(f),name:f.name,type:f.type}));
      }
    }

    async function sendMessage(text){
      const trimmed=(text||"").trim();
      if(!trimmed && !pendingFiles.length) return;

      const uploads=await uploadFiles(pendingFiles);
      addMessage("user",trimmed,uploads);
      chatInput.value="";
      pendingFiles=[]; renderPending();

      const typing=document.createElement("div");
      typing.className="fade-in rounded-xl bg-brandSoft p-4 bubble w-full";
      typing.innerHTML=`<div class="flex items-center gap-2 text-xs text-brandMuted">
                          <span class="w-6 h-6 grid place-items-center bg-brandPrimary text-white rounded-full">‚óÜ</span>
                          Assistant</div>
                        <div class="mt-2 flex gap-1">
                          <span class="typing-dot w-2 h-2 rounded-full bg-brandMuted"></span>
                          <span class="typing-dot w-2 h-2 rounded-full bg-brandMuted"></span>
                          <span class="typing-dot w-2 h-2 rounded-full bg-brandMuted"></span>
                        </div>`;
      messages.appendChild(typing); messages.scrollTop=messages.scrollHeight;

      try{
        const res=await fetch(`${API_BASE}/api/chat`,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({
            message: trimmed,
            session_id: SESSION_ID,
            mode: CHAT_MODE,        // ‚Üê force LEARN prompt
            attachments: uploads    // (backend currently ignores attachments)
          })
        });
        const data=await res.json().catch(()=>({reply:"‚ö†Ô∏è Invalid response"}));
        typing.remove();
        addMessage("assistant", (data && data.reply) || "‚ö†Ô∏è No reply");
      }catch(err){
        typing.remove();
        addMessage("assistant","‚ö†Ô∏è Network error: "+(err && err.message ? err.message : String(err)));
      }
    }

    form.addEventListener("submit",e=>{e.preventDefault();sendMessage(chatInput.value);});
    chatInput.addEventListener("keydown",e=>{
      if(e.key==="Enter" && !e.shiftKey){e.preventDefault();sendMessage(chatInput.value);}
    });
  </script>
</body>
</html>

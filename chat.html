// ================================
// package.json
// ================================
{
  "name": "ledgerdaddy-chat",
  "version": "1.0.0",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview",
    "mock": "node mock/server.mjs"
  },
  "dependencies": {
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-markdown": "^9.0.3",
    "remark-gfm": "^4.0.0",
    "rehype-raw": "^7.0.0",
    "rehype-highlight": "^7.0.0",
    "highlight.js": "^11.9.0",
    "clsx": "^2.1.1"
  },
  "devDependencies": {
    "@vitejs/plugin-react": "^4.3.1",
    "vite": "^5.4.2"
  }
}

// ================================
// vite.config.js
// ================================
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  server: {
    port: 5173,
    proxy: {
      // When using the mock server: `npm run mock` (port 8787)
      '/api': {
        target: 'http://localhost:8787',
        changeOrigin: true,
        ws: false,
      }
    }
  }
})

// ================================
// index.html
// ================================
<!doctype html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#1A237E" />
    <title>LedgerDaddy AI ‚Äì Chat</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: ['class', '[data-theme="dark"]'],
        theme: {
          extend: {
            colors: {
              indigoDeep: '#1A237E',
              emerald: '#2E7D32',
              cyanBright: '#00BCD4',
              accentOrange: '#FF7043',
            },
            boxShadow: {
              lift: '0 8px 30px rgba(0,0,0,.12)'
            },
            borderRadius: {
              '2xl': '16px'
            }
          }
        }
      }
    </script>
    <style>
      :root {
        --indigoDeep:#1A237E; --emerald:#2E7D32; --cyanBright:#00BCD4; --accentOrange:#FF7043;
        --bg:#0B1020; --surface:#11172B; --border:#26324B; --text:#E6EAF2; --muted:#9AA8C7;
      }
      html, body, #root { height: 100%; }
      .glass { backdrop-filter: saturate(160%) blur(8px); background: rgba(17,23,43,.6) }
      .scrollbar-thin { scrollbar-width: thin }
      .caret { display:inline-block; width:8px; height:1em; translate: 0 .2em; background: currentColor; animation: blink 1s steps(1) infinite }
      @keyframes blink { 0%,49%{opacity:1} 50%,100%{opacity:.15} }
      .table-wrap { overflow-x:auto }
      /* High contrast toggle */
      [data-contrast="high"] * { letter-spacing: .2px }
      [data-contrast="high"] .hc-border { border-color: #8ea2c6 !important }
    </style>
  </head>
  <body class="h-full bg-[var(--bg)] text-[var(--text)]">
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>

// ================================
// src/main.jsx
// ================================
import React from 'react'
import { createRoot } from 'react-dom/client'
import App from './App.jsx'

createRoot(document.getElementById('root')).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
)

// ================================
// src/lib/storage.js
// ================================
export const ls = {
  get(key, fallback) {
    try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback } catch { return fallback }
  },
  set(key, value) {
    try { localStorage.setItem(key, JSON.stringify(value)) } catch {}
  }
}

export const KEYS = {
  threads: 'ld_threads_v2',
  theme: 'ld_theme',
  contrast: 'ld_contrast',
  sidebar: 'ld_sidebar_open',
}

// ================================
// src/lib/chatClient.js
// Swappable client. Default points to your Flask API on Render, but supports
// SSE/streaming and a built-in mock for offline usage.
// ================================
const DEFAULT_BASE = import.meta.env.VITE_API_BASE || 'https://chadaddy.onrender.com'

export function createChatClient() {
  let controller = null

  async function send({ messages, attachments = [], onDelta, onDone, mode = 'core', sessionId }) {
    if (controller) controller.abort()
    controller = new AbortController()

    const base = DEFAULT_BASE
    const url = base === 'mock' ? '/api/chat' : base + '/api/chat'

    // Prefer backend streaming via SSE/text; otherwise fall back to JSON then simulate streaming
    try {
      // If using Render Flask (non-stream JSON: {reply})
      const payload = (base.includes('onrender') || base.includes('http'))
        ? { message: messages[messages.length - 1]?.content || '', mode, session_id: sessionId }
        : { messages, attachments }

      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        signal: controller.signal,
      })

      const ctype = res.headers.get('content-type') || ''
      if (!res.ok) throw new Error(`HTTP ${res.status}`)

      if (ctype.includes('text/event-stream')) {
        // SSE: parse lines starting with "data:"
        const reader = res.body.getReader()
        const decoder = new TextDecoder()
        let buffer = ''
        while (true) {
          const { value, done } = await reader.read()
          if (done) break
          buffer += decoder.decode(value, { stream: true })
          const parts = buffer.split('\n\n')
          for (let i = 0; i < parts.length - 1; i++) {
            const line = parts[i]
            if (line.startsWith('data: ')) {
              onDelta?.(line.slice(6))
            }
          }
          buffer = parts[parts.length - 1]
        }
        onDone?.()
        return
      }

      if (res.body && !ctype.includes('application/json')) {
        // Chunked text/ReadableStream
        const reader = res.body.getReader()
        const decoder = new TextDecoder()
        while (true) {
          const { value, done } = await reader.read()
          if (done) break
          onDelta?.(decoder.decode(value))
        }
        onDone?.()
        return
      }

      // JSON fallback (Flask on Render)
      const json = await res.json()
      const reply = json.reply || json.text || ''
      // Simulate streaming for UX
      for (const ch of reply) {
        await new Promise(r => setTimeout(r, 8))
        onDelta?.(ch)
      }
      onDone?.()
    } catch (err) {
      if (err.name === 'AbortError') return
      throw err
    }
  }

  function stop() {
    if (controller) controller.abort()
    controller = null
  }

  async function upload(files) {
    const base = DEFAULT_BASE
    const url = base === 'mock' ? '/api/upload' : base + '/api/upload'
    const form = new FormData()
    for (const f of files) form.append('file', f, f.name)
    const res = await fetch(url, { method: 'POST', body: form })
    if (!res.ok) throw new Error('Upload failed')
    return res.json() // [{id,name,size,mime,url},...]
  }

  return { send, stop, upload }
}

// ================================
// src/lib/useAutoScroll.js
// ================================
import { useEffect, useRef, useState } from 'react'
export function useAutoScroll(dep) {
  const ref = useRef(null)
  const [paused, setPaused] = useState(false)
  useEffect(() => {
    const el = ref.current
    if (!el) return
    const onScroll = () => {
      const nearBottom = el.scrollHeight - el.scrollTop - el.clientHeight < 60
      setPaused(!nearBottom)
    }
    el.addEventListener('scroll', onScroll)
    return () => el.removeEventListener('scroll', onScroll)
  }, [])
  useEffect(() => {
    const el = ref.current
    if (!el || paused) return
    el.scrollTop = el.scrollHeight
  }, [dep, paused])
  return ref
}

// ================================
// src/components/CodeBlock.jsx
// ================================
import React, { useEffect, useRef } from 'react'
import hljs from 'highlight.js'
import 'highlight.js/styles/github-dark.css'

export default function CodeBlock({ language, value }) {
  const preRef = useRef()
  useEffect(() => {
    if (preRef.current) hljs.highlightElement(preRef.current)
  }, [value])
  return (
    <div className="relative">
      <button
        className="absolute right-2 top-2 text-xs border border-[var(--border)] bg-[var(--surface)] rounded px-2 py-1 hover:opacity-90"
        onClick={() => navigator.clipboard.writeText(value)}
        aria-label="Copy code"
      >Copy</button>
      <pre className="rounded-2xl border border-[var(--border)] bg-[#0f172a] text-slate-200 overflow-auto">
        <code ref={preRef} className={`language-${language || ''}`}>{value}</code>
      </pre>
    </div>
  )
}

// ================================
// src/components/MessageItem.jsx
// ================================
import React from 'react'
import ReactMarkdown from 'react-markdown'
import remarkGfm from 'remark-gfm'
import rehypeRaw from 'rehype-raw'
import rehypeHighlight from 'rehype-highlight'
import CodeBlock from './CodeBlock.jsx'

export default function MessageItem({ m, onCopy, onDelete, onEdit }) {
  const isUser = m.role === 'user'
  return (
    <div className={`rounded-2xl border hc-border border-[var(--border)] bg-[var(--surface)] p-4 shadow-lift ${isUser ? '' : ''}`} role="listitem" aria-label={`${isUser ? 'User' : 'Assistant'} message`}>
      <div className="flex items-center gap-2 text-sm text-[var(--muted)]">
        <span className={`grid h-7 w-7 place-items-center rounded-full ${isUser ? 'bg-gray-600/30' : 'bg-indigoDeep text-white'}`}>{isUser ? 'üë§' : '‚óÜ'}</span>
        <span>{isUser ? 'You' : 'Assistant'}</span>
        <div className="ml-auto flex items-center gap-2 opacity-80">
          {isUser && (
            <button className="text-xs underline" onClick={() => onEdit?.(m)} aria-label="Edit message">Edit</button>
          )}
          <button className="text-xs underline" onClick={() => onCopy?.(m)} aria-label="Copy message">Copy</button>
          <button className="text-xs underline text-red-400" onClick={() => onDelete?.(m)} aria-label="Delete message">Delete</button>
        </div>
      </div>
      <div className="mt-2 prose prose-invert max-w-none">
        <ReactMarkdown
          remarkPlugins={[remarkGfm]}
          rehypePlugins={[rehypeRaw, rehypeHighlight]}
          components={{
            code({ inline, className, children, ...props }) {
              const m = /language-(\w+)/.exec(className || '')
              const language = m?.[1]
              const content = String(children).replace(/\n$/, '')
              if (inline) {
                return <code className="bg-black/30 px-1.5 py-0.5 rounded text-[90%]" {...props}>{children}</code>
              }
              return <CodeBlock language={language} value={content} />
            },
            table({ children }) {
              return <div className="table-wrap">{children}</div>
            }
          }}
        >{m.content}</ReactMarkdown>
        {m.attachments?.length ? (
          <div className="mt-3 flex flex-wrap gap-2">
            {m.attachments.map(att => (
              <a key={att.id} href={att.url} target="_blank" rel="noreferrer" className="text-xs border border-[var(--border)] rounded-full px-2 py-1 hover:bg-white/5" aria-label={`Open attachment ${att.name}`}>{att.name} ¬∑ {(att.size/1024).toFixed(1)} KB</a>
            ))}
          </div>
        ) : null}
      </div>
    </div>
  )
}

// ================================
// src/components/Sidebar.jsx
// ================================
import React, { useMemo, useState } from 'react'
import { clsx } from 'clsx'

function groupByDate(threads) {
  const today = []
  const week = []
  const older = []
  const now = new Date()
  for (const t of threads) {
    const d = new Date(t.createdAt || t.updatedAt || Date.now())
    const diff = (now - d) / (1000*60*60*24)
    if (diff < 1) today.push(t)
    else if (diff < 7) week.push(t)
    else older.push(t)
  }
  return { today, week, older }
}

export default function Sidebar({
  open,
  setOpen,
  threads,
  currentId,
  onNew,
  onSelect,
  onRename,
  onDelete,
  onPin,
}) {
  const [q, setQ] = useState('')
  const filtered = useMemo(() => {
    const f = (threads || []).filter(t => t.title?.toLowerCase().includes(q.toLowerCase()))
    // pinned to top
    return [...f.filter(t => t.pinned), ...f.filter(t => !t.pinned)]
  }, [threads, q])
  const { today, week, older } = useMemo(() => groupByDate(filtered), [filtered])

  const Section = ({ title, items }) => (
    items.length ? (
      <div className="mt-3">
        <div className="text-xs uppercase tracking-wide text-[var(--muted)] mb-1">{title}</div>
        <ul role="list" className="grid gap-1">
          {items.map(t => (
            <li key={t.id}>
              <button
                className={clsx(
                  'w-full text-left px-2 py-2 rounded-2xl hover:bg-white/5 border border-transparent hover:border-[var(--border)]',
                  t.id === currentId && 'bg-white/10 border-[var(--border)]'
                )}
                onClick={() => onSelect(t.id)}
                aria-label={`Open conversation ${t.title}`}
              >
                <div className="flex items-center gap-2">
                  {t.pinned ? <span title="Pinned">üìå</span> : <span className="opacity-50">üí¨</span>}
                  <div className="truncate">{t.title || 'Conversation'}</div>
                </div>
                <div className="text-[11px] opacity-70 mt-0.5">{(t.messages?.length||0)} messages</div>
              </button>
              <div className="flex gap-2 mt-1 ml-6">
                <button className="text-[11px] underline" onClick={() => onRename(t.id)}>Rename</button>
                <button className="text-[11px] underline" onClick={() => onPin(t.id)}>{t.pinned?'Unpin':'Pin'}</button>
                <button className="text-[11px] underline text-red-400" onClick={() => onDelete(t.id)}>Delete</button>
              </div>
            </li>
          ))}
        </ul>
      </div>
    ) : null
  )

  return (
    <aside className={clsx(
      'h-[calc(100vh-64px)] sticky top-16 p-3 rounded-2xl border border-[var(--border)] glass overflow-hidden',
      open ? 'w-72' : 'w-0 md:w-16',
      'transition-all duration-200'
    )} aria-label="Sidebar">
      <div className={clsx('h-full flex flex-col', open ? 'opacity-100' : 'opacity-0 md:opacity-100')}>
        <div className="flex items-center gap-2">
          <button className="text-sm border border-[var(--border)] rounded-xl px-2 py-1" onClick={onNew}>New Chat</button>
          <button className="ml-auto text-sm border border-[var(--border)] rounded-xl px-2 py-1" onClick={() => setOpen(!open)} aria-label="Toggle sidebar">{open?'Hide':'Show'}</button>
        </div>
        <input
          value={q}
          onChange={e=>setQ(e.target.value)}
          placeholder="Search‚Ä¶"
          className="mt-3 w-full bg-black/20 border border-[var(--border)] rounded-xl px-3 py-2 outline-none"
          aria-label="Search conversations"
        />
        <div className="flex-1 overflow-auto mt-2 pr-1 scrollbar-thin">
          <Section title="Today" items={today} />
          <Section title="Previous 7 days" items={week} />
          <Section title="Older" items={older} />
        </div>
      </div>
    </aside>
  )
}

// ================================
// src/components/ChatHeader.jsx
// ================================
import React from 'react'

export default function ChatHeader({ sidebarOpen, setSidebarOpen, status = 'online', onNewChat, onOpenSettings }) {
  return (
    <header className="fixed top-0 inset-x-0 z-40 border-b border-[var(--border)] glass">
      <div className="max-w-5xl mx-auto px-4 h-16 flex items-center gap-3">
        <button className="md:hidden border border-[var(--border)] rounded-xl px-2 py-1" onClick={()=>setSidebarOpen(!sidebarOpen)} aria-label="Toggle sidebar">‚ò∞</button>
        <div className="flex items-center gap-2 select-none">
          <span className="grid h-9 w-9 place-items-center rounded-2xl bg-gradient-to-tr from-cyanBright to-emerald text-white font-extrabold shadow">‚óÜ</span>
          <div>
            <div className="font-bold">LedgerDaddy AI</div>
            <div className="text-xs opacity-70 flex items-center gap-1"><span className={`h-2 w-2 rounded-full ${status==='online'?'bg-emerald':'bg-accentOrange'}`}></span>{status==='online'?'Ready':'Offline'}</div>
          </div>
        </div>
        <div className="ml-auto flex items-center gap-2">
          <button className="border border-[var(--border)] rounded-xl px-3 py-1.5 hover:bg-white/5" onClick={onNewChat}>New Chat</button>
          <button className="border border-[var(--border)] rounded-xl px-3 py-1.5" onClick={onOpenSettings} aria-label="Open settings">‚öôÔ∏è</button>
        </div>
      </div>
    </header>
  )
}

// ================================
// src/components/Composer.jsx
// ================================
import React, { useEffect, useRef, useState } from 'react'

export default function Composer({
  value, setValue, onSend, uploading, onUpload, attachments, onRemoveAttachment,
  streaming, onStop, onRegenerate, suggested = []
}) {
  const areaRef = useRef(null)
  const [chars, setChars] = useState(0)

  useEffect(() => {
    if (!areaRef.current) return
    const el = areaRef.current
    el.style.height = 'auto'
    el.style.height = Math.min(el.scrollHeight, 180) + 'px'
    setChars(el.value.length)
  }, [value])

  const approxTokens = Math.ceil(chars / 4)

  function onKeyDown(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault()
      onSend()
    }
    if ((e.metaKey || e.ctrlKey) && e.key === '/') {
      e.preventDefault(); areaRef.current?.focus()
    }
  }

  return (
    <div className="fixed bottom-0 inset-x-0 border-t border-[var(--border)] bg-[var(--surface)]/95 backdrop-blur p-3">
      <div className="max-w-3xl mx-auto">
        <div className="flex flex-wrap gap-2 mb-2">
          {suggested.map((s, i) => (
            <button key={i} className="text-xs border border-[var(--border)] rounded-full px-2 py-1 hover:bg-white/5" onClick={() => setValue(v => (v ? v + '\n' : '') + s)}>{s}</button>
          ))}
        </div>
        <div className="flex items-end gap-2">
          <label className="cursor-pointer border border-[var(--border)] rounded-xl px-3 py-2 hover:bg-white/5">
            <input type="file" multiple className="hidden" onChange={e => onUpload([...e.target.files])} />üìé
          </label>
          <textarea
            ref={areaRef}
            value={value}
            onChange={e=>setValue(e.target.value)}
            onKeyDown={onKeyDown}
            placeholder="Hey, I‚Äôm your customs agent. Ask anything‚ÄîHS codes, duties, documents. You can also attach files."
            className="flex-1 rounded-2xl border border-[var(--border)] bg-black/20 px-3 py-2 resize-none outline-none"
            rows={1}
            aria-label="Message input"
          />
          {!streaming ? (
            <button className="rounded-2xl px-4 py-2 bg-gradient-to-r from-cyanBright to-emerald text-black font-semibold hover:scale-[1.01] transition" onClick={onSend} aria-label="Send message">Send</button>
          ) : (
            <>
              <button className="rounded-2xl px-4 py-2 bg-accentOrange text-black font-semibold" onClick={onStop}>Stop</button>
              <button className="rounded-2xl px-4 py-2 border border-[var(--border)]" onClick={onRegenerate}>Regenerate</button>
            </>
          )}
        </div>
        <div className="mt-2 flex items-center gap-2 flex-wrap">
          {attachments.map(att => (
            <span key={att.id} className="text-xs border border-[var(--border)] rounded-full px-2 py-1">
              {att.name} ¬∑ {(att.size/1024).toFixed(1)} KB
              <button className="ml-2 opacity-70 hover:opacity-100" onClick={() => onRemoveAttachment(att.id)} aria-label={`Remove ${att.name}`}>‚úï</button>
            </span>
          ))}
          <span className="ml-auto text-[11px] opacity-70">{chars} chars ¬∑ ~{approxTokens} tokens</span>
        </div>
      </div>
    </div>
  )
}

// ================================
// src/components/SettingsModal.jsx
// ================================
import React from 'react'

export default function SettingsModal({ open, onClose, theme, setTheme, contrast, setContrast }) {
  if (!open) return null
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center">
      <div className="absolute inset-0 bg-black/60" onClick={onClose} aria-hidden="true"></div>
      <div className="relative w-full max-w-md rounded-2xl border border-[var(--border)] bg-[var(--surface)] p-4">
        <div className="text-lg font-semibold">Settings</div>
        <div className="mt-3 grid gap-3">
          <label className="flex items-center justify-between">
            <span>Theme</span>
            <select value={theme} onChange={e => setTheme(e.target.value)} className="border border-[var(--border)] bg-black/20 rounded px-2 py-1">
              <option value="dark">Dark</option>
              <option value="light">Light</option>
              <option value="system">System</option>
            </select>
          </label>
          <label className="flex items-center justify-between">
            <span>High contrast</span>
            <select value={contrast} onChange={e => setContrast(e.target.value)} className="border border-[var(--border)] bg-black/20 rounded px-2 py-1">
              <option value="normal">Normal</option>
              <option value="high">High</option>
            </select>
          </label>
        </div>
        <div className="mt-4 text-right">
          <button className="border border-[var(--border)] rounded-xl px-3 py-1.5" onClick={onClose}>Close</button>
        </div>
      </div>
    </div>
  )
}

// ================================
// src/components/CommandPalette.jsx
// ================================
import React, { useEffect } from 'react'

export default function CommandPalette({ open, setOpen, onInsert }) {
  useEffect(() => {
    const onKey = (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'k') {
        e.preventDefault(); setOpen(v => !v)
      }
      if (e.key === 'Escape') setOpen(false)
    }
    window.addEventListener('keydown', onKey)
    return () => window.removeEventListener('keydown', onKey)
  }, [setOpen])

  if (!open) return null
  const items = [
    'Find HS code for wireless earbuds in IN',
    'Duty for IN 851713 CIF 100000',
    'Docs to import wooden furniture into EU',
  ]
  return (
    <div className="fixed inset-0 z-50">
      <div className="absolute inset-0 bg-black/50" onClick={()=>setOpen(false)}></div>
      <div className="relative max-w-xl mx-auto mt-24 rounded-2xl border border-[var(--border)] bg-[var(--surface)] p-3">
        <div className="text-sm opacity-80 mb-2">Command Palette</div>
        <ul className="grid gap-1">
          {items.map((t,i)=> (
            <li key={i}>
              <button className="w-full text-left px-3 py-2 rounded-xl hover:bg-white/5" onClick={()=>{onInsert(t); setOpen(false)}}>{t}</button>
            </li>
          ))}
        </ul>
        <div className="text-[11px] opacity-70 mt-2">Press Esc to close</div>
      </div>
    </div>
  )
}

// ================================
// src/components/MessageList.jsx
// ================================
import React from 'react'
import MessageItem from './MessageItem.jsx'

export default function MessageList({ items, streaming }) {
  return (
    <div aria-live="polite" aria-busy={streaming} className="space-y-3">
      {items.map(m => <MessageItem key={m.id} m={m} />)}
      {streaming && (
        <div className="rounded-2xl border border-[var(--border)] bg-[var(--surface)] p-4 text-sm opacity-80">Assistant is typing <span className="caret"></span></div>
      )}
    </div>
  )
}

// ================================
// src/App.jsx
// ================================
import React, { useEffect, useMemo, useState } from 'react'
import ChatHeader from './components/ChatHeader.jsx'
import Sidebar from './components/Sidebar.jsx'
import MessageList from './components/MessageList.jsx'
import Composer from './components/Composer.jsx'
import SettingsModal from './components/SettingsModal.jsx'
import CommandPalette from './components/CommandPalette.jsx'
import { createChatClient } from './lib/chatClient.js'
import { useAutoScroll } from './lib/useAutoScroll.js'
import { ls, KEYS } from './lib/storage.js'

const client = createChatClient()

function uid() { return Math.random().toString(36).slice(2) + Date.now().toString(36) }

export default function App() {
  // Theme + contrast (persist)
  const [theme, setTheme] = useState(ls.get(KEYS.theme, 'dark'))
  const [contrast, setContrast] = useState(ls.get(KEYS.contrast, 'normal'))
  useEffect(() => { ls.set(KEYS.theme, theme) }, [theme])
  useEffect(() => { ls.set(KEYS.contrast, contrast) }, [contrast])
  useEffect(() => {
    if (theme === 'dark') document.documentElement.setAttribute('data-theme','dark')
    if (theme === 'light') document.documentElement.removeAttribute('data-theme')
    if (theme === 'system') {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches
      if (prefersDark) document.documentElement.setAttribute('data-theme','dark')
      else document.documentElement.removeAttribute('data-theme')
    }
    document.documentElement.setAttribute('data-contrast', contrast)
  }, [theme, contrast])

  // Sidebar state
  const [sidebarOpen, setSidebarOpen] = useState(ls.get(KEYS.sidebar, true))
  useEffect(() => { ls.set(KEYS.sidebar, sidebarOpen) }, [sidebarOpen])

  // Conversations
  const [threads, setThreads] = useState(ls.get(KEYS.threads, []))
  const [currentId, setCurrentId] = useState(threads[0]?.id || '')
  useEffect(() => { ls.set(KEYS.threads, threads) }, [threads])

  const current = useMemo(() => threads.find(t => t.id === currentId), [threads, currentId])

  function newThread() {
    const id = uid()
    const t = { id, title: 'New chat', pinned: false, createdAt: Date.now(), updatedAt: Date.now(), messages: [] }
    setThreads(s => [t, ...s]); setCurrentId(id)
  }

  function setTitleFromFirstUserMessage(t) {
    const first = t.messages.find(m => m.role === 'user')
    if (first) t.title = (first.content || 'Conversation').slice(0, 60)
  }

  // Messaging
  const [input, setInput] = useState('')
  const [attachments, setAttachments] = useState([])
  const [streaming, setStreaming] = useState(false)
  const [settingsOpen, setSettingsOpen] = useState(false)
  const [paletteOpen, setPaletteOpen] = useState(false)

  const listRef = useAutoScroll(current?.messages?.length || 0)

  useEffect(() => { if (!threads.length) newThread() }, [])

  function pushMessage(role, content, extra = {}) {
    setThreads(s => s.map(t => t.id !== currentId ? t : {
      ...t,
      messages: [...t.messages, { id: uid(), role, content, ...extra }],
      updatedAt: Date.now()
    }))
  }

  function replaceLastAssistant(content) {
    setThreads(s => s.map(t => t.id !== currentId ? t : {
      ...t,
      messages: t.messages.map((m, i, arr) => i === arr.length - 1 ? { ...m, content } : m),
      updatedAt: Date.now()
    }))
  }

  function onCopy(m) { navigator.clipboard.writeText(m.content) }
  function onDelete(m) { setThreads(s => s.map(t => t.id !== currentId ? t : { ...t, messages: t.messages.filter(x => x.id !== m.id), updatedAt: Date.now() })) }
  function onEdit(m) {
    const edited = prompt('Edit your message:', m.content)
    if (edited == null) return
    // Replace from this message onward and resend
    setThreads(s => s.map(t => {
      if (t.id !== currentId) return t
      const idx = t.messages.findIndex(x => x.id === m.id)
      const newMsgs = [...t.messages.slice(0, idx), { ...m, content: edited }]
      return { ...t, messages: newMsgs, updatedAt: Date.now() }
    }))
    // After state flush, send again
    setTimeout(() => sendNow(edited, true), 0)
  }

  async function onUpload(files) {
    try {
      const items = await client.upload(files)
      setAttachments(a => [...a, ...items])
    } catch (e) {
      alert('Upload failed: ' + e.message)
    }
  }

  function removeAttachment(id) { setAttachments(a => a.filter(x => x.id !== id)) }

  async function sendNow(text = input, editedFlow = false) {
    const trimmed = (text || '').trim()
    if (!trimmed) return
    if (!current) return

    // new user message
    const msgAttachments = attachments
    setAttachments([])
    pushMessage('user', trimmed, { attachments: msgAttachments })

    // Title auto-generate
    setThreads(s => s.map(t => { if (t.id === currentId && t.title === 'New chat') { setTitleFromFirstUserMessage(t) } return t }))

    // assistant placeholder
    pushMessage('assistant', '')
    setStreaming(true)

    const onDelta = (chunk) => {
      replaceLastAssistant((current => current + chunk)(threads.find(t => t.id===currentId)?.messages?.at(-1)?.content || ''))
    }

    const onDone = () => setStreaming(false)

    try {
      const history = threads.find(t => t.id === currentId)?.messages || []
      const messages = editedFlow ? history : [...history, { role: 'user', content: trimmed }]
      await client.send({ messages, attachments: msgAttachments, onDelta, onDone, mode: 'core', sessionId: sessionStorage.getItem('ld_session') || ensureSession() })
    } catch (e) {
      replaceLastAssistant('‚ö†Ô∏è Error: ' + e.message)
      setStreaming(false)
    }
  }

  function ensureSession() {
    let v = sessionStorage.getItem('ld_session')
    if (!v) { v = crypto?.randomUUID?.() || 'sess_' + uid(); sessionStorage.setItem('ld_session', v) }
    return v
  }

  function stop() { client.stop(); setStreaming(false) }
  function regenerate() {
    const lastUser = [...(current?.messages||[])].reverse().find(m => m.role === 'user')
    if (!lastUser) return
    sendNow(lastUser.content, true)
  }

  const suggested = [
    'Find HS code for wireless earbuds in IN',
    'Duty for IN 851713 CIF 100000',
    'Docs to import wooden furniture into EU',
  ]

  return (
    <div className="min-h-full pb-40" data-theme={theme==='dark'?'dark':undefined} data-contrast={contrast}>
      <ChatHeader sidebarOpen={sidebarOpen} setSidebarOpen={setSidebarOpen} onNewChat={newThread} onOpenSettings={()=>setSettingsOpen(true)} />
      <main className="max-w-5xl mx-auto pt-20 px-3 md:px-6 grid grid-cols-1 md:grid-cols-[280px,1fr] gap-4">
        <Sidebar
          open={sidebarOpen}
          setOpen={setSidebarOpen}
          threads={threads}
          currentId={currentId}
          onNew={newThread}
          onSelect={setCurrentId}
          onRename={(id)=>{
            const name = prompt('Rename conversation:')
            if (name == null) return
            setThreads(s => s.map(t => t.id===id?{...t,title:name}:t))
          }}
          onDelete={(id)=>setThreads(s => s.filter(t => t.id!==id))}
          onPin={(id)=>setThreads(s => s.map(t => t.id===id?{...t,pinned:!t.pinned}:t))}
        />
        <section className="min-h-[60vh] rounded-2xl border border-[var(--border)] bg-[var(--surface)] p-4">
          {current?.messages?.length ? (
            <div ref={listRef} className="h-[calc(100vh-220px)] overflow-auto pr-1 scrollbar-thin">
              <MessageList items={current.messages} streaming={streaming} />
            </div>
          ) : (
            <div className="h-[calc(100vh-220px)] grid place-items-center text-center">
              <div>
                <div className="text-2xl font-bold">Welcome to LedgerDaddy AI</div>
                <p className="mt-2 opacity-80">Ask about HS codes, duties, valuation, documents, or attach invoices for parsing.</p>
                <div className="mt-4 flex flex-wrap gap-2 justify-center">
                  {suggested.map((s,i)=>(
                    <button key={i} className="text-sm border border-[var(--border)] rounded-full px-3 py-1.5 hover:bg-white/5" onClick={()=>setInput(s)}>{s}</button>
                  ))}
                </div>
              </div>
            </div>
          )}
        </section>
      </main>

      <Composer
        value={input}
        setValue={setInput}
        onSend={()=>sendNow()}
        uploading={false}
        onUpload={onUpload}
        attachments={attachments}
        onRemoveAttachment={removeAttachment}
        streaming={streaming}
        onStop={stop}
        onRegenerate={regenerate}
        suggested={suggested}
      />

      <SettingsModal open={settingsOpen} onClose={()=>setSettingsOpen(false)} theme={theme} setTheme={setTheme} contrast={contrast} setContrast={setContrast} />
      <CommandPalette open={paletteOpen} setOpen={setPaletteOpen} onInsert={setInput} />
    </div>
  )
}

// ================================
// mock/server.mjs
// Simple Express mock that streams SSE for /api/chat and accepts uploads.
// Run: npm run mock (starts on :8787), and `npm run dev` in another terminal (or use vite proxy)
// ================================
import express from 'express'
import cors from 'cors'
import multer from 'multer'

const app = express()
const upload = multer({ storage: multer.memoryStorage() })
app.use(cors())
app.use(express.json())

app.post('/api/chat', (req, res) => {
  const { message, messages } = req.body || {}
  const prompt = message || messages?.at(-1)?.content || 'Hello'
  res.setHeader('Content-Type', 'text/event-stream')
  res.setHeader('Cache-Control', 'no-cache')
  res.setHeader('Connection', 'keep-alive')
  const text = `Sure! You asked: **${prompt}**.\n\nHere is a *mock streamed* reply with a table and code.\n\n| Step | Action |\n| --- | --- |\n| 1 | Parse input |\n| 2 | Call API |\n| 3 | Stream back |\n\n\`\`\`js\nconsole.log('Hello from mock stream')\n\`\`\``
  let i = 0
  const timer = setInterval(() => {
    if (i >= text.length) { clearInterval(timer); res.write(`data: [DONE]\n\n`); res.end(); return }
    res.write('data: ' + text[i++] + '\n\n')
  }, 6)
})

app.post('/api/upload', upload.array('file'), (req, res) => {
  const out = (req.files || []).map((f, i) => ({ id: Date.now()+''+i, name: f.originalname, size: f.size, mime: f.mimetype, url: `blob:${f.originalname}` }))
  res.json(out)
})

const PORT = 8787
app.listen(PORT, () => console.log('Mock server on http://localhost:' + PORT))

// ================================
// README.md (quick)
// ================================
# LedgerDaddy Chat (React + Vite)

**Run dev (mock backend)**

```bash
npm i
npm run mock   # terminal A ‚Äì SSE mock on :8787
npm run dev    # terminal B ‚Äì Vite on :5173 (proxy /api ‚Üí :8787)
```

Open http://localhost:5173

**Point to real Flask (Render)**

- Stop the mock. Start only `npm run dev`.
- Create `.env` with:

```
VITE_API_BASE=https://chadaddy.onrender.com
```

- Rebuild/refresh. The app will call `POST https://chadaddy.onrender.com/api/chat` with `{ message, mode, session_id }` to preserve your existing connection. If the server returns JSON `{reply: "..."}`, the UI simulates streaming for an authentic ChatGPT feel.

**Production build**

```bash
npm run build
npm run preview
```

**Keyboard shortcuts**
- **Enter** send, **Shift+Enter** newline
- **Cmd/Ctrl+/** focus composer
- **Cmd/Ctrl+K** command palette
- **Esc** closes dialogs / palette

**Exact ChatGPT UX pieces implemented**
- Sidebar (collapsible, persists), sections (Today/7 days/Older), search, pin/rename/delete
- Sticky header & composer; auto-grow textarea; drag-drop/upload; pills; remove
- Streaming with blinking caret; Stop/Regenerate replaces Send
- Edit last message (prompt), copy/delete actions
- Markdown with tables and syntax-highlighted code + Copy
- Auto-scroll with pause when scrolled up
- Light/Dark + High-contrast toggles (persist), respects system
- Local persistence for conversations, titles (first user line, 60 chars)
- Accessibility: proper roles, aria-live for stream, focusable controls
- Mobile safe-area-friendly bottom composer

**Swap API**
- All network logic is in `src/lib/chatClient.js` ‚Üí `send(messages, attachments, onDelta)` and `upload(files)`.
- For backends that accept `messages[]` and stream SSE, it will consume directly. For your Flask on Render, it sends `{ message, mode, session_id }`.

// ================================
// (Optional) KEEP YOUR EXISTING HTML PAGE WORKING
// If you need to embed this SPA into your current site without breaking other routes,
// host the Vite build at /chat/ and link to it. The API endpoint stays the same.
// ================================

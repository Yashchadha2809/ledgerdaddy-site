<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Log in ‚Äì Chadaddy</title>
  <meta name="theme-color" content="#111827" />
  <link rel="preconnect" href="https://images.unsplash.com" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors:{
            brandPrimary:"#111827",
            brandAccent:"#2563EB",
            brandSoft:"#EFF6FF",
            brandBorder:"#E5E7EB",
            brandMuted:"#6B7280",
            brandBg:"#F9FAFB"
          },
          boxShadow:{ lift:"0 14px 34px rgba(17,24,39,.06)" },
          backgroundImage:{
            "soft-gradient":"linear-gradient(135deg, #EFF6FF 0%, #FFFFFF 100%)"
          }
        }
      }
    }
  </script>
  <style>
    .card{transition:transform .12s ease, box-shadow .2s ease}
    .card:hover{transform:translateY(-2px); box-shadow:0 14px 34px rgba(17,24,39,.10)}
    .hero-img{background:url('https://images.unsplash.com/photo-1586521995568-39ef16c6934d?q=80&w=1920&auto=format&fit=crop') center/cover no-repeat;}
  </style>
</head>
<body class="bg-brandBg text-brandPrimary">

  <!-- Topbar -->
  <header class="fixed top-0 inset-x-0 z-50 border-b border-brandBorder bg-white/90 backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="index.html" class="flex items-center gap-2" aria-label="Home">
        <span class="grid h-9 w-9 place-items-center rounded-xl bg-soft-gradient text-brandPrimary font-extrabold shadow">‚óÜ</span>
        <span class="text-xl font-bold">Chadaddy</span>
        <span class="ml-2 hidden sm:inline-flex text-[11px] px-2 py-0.5 rounded-full border border-brandAccent/40 text-brandAccent">AI Customs</span>
      </a>
      <nav class="hidden md:flex items-center gap-6 text-sm font-medium" aria-label="Main">
        <a href="index.html#marketplace" class="hover:text-brandAccent">Marketplace</a>
        <a href="index.html#calculator"  class="hover:text-brandAccent">Calculator</a>
        <a href="index.html#hsfinder"   class="hover:text-brandAccent">HS Finder</a>
        <a href="index.html#chat"       class="hover:text-brandAccent">Chat</a>
        <a href="index.html#news"       class="hover:text-brandAccent">News</a>
        <a href="index.html#learn"      class="hover:text-brandAccent">Academy</a>
        <a href="index.html#pricing"    class="hover:text-brandAccent">Pricing</a>
      </nav>
      <div class="hidden md:flex items-center gap-2">
        <a href="log-in.html" class="border border-brandBorder px-4 py-2 rounded-lg">Log in</a>
        <a href="personal_sign_up.html" class="bg-brandAccent text-white px-4 py-2 rounded-lg hover:opacity-95">Sign up</a>
      </div>
      <a href="personal-sign-up.html" class="md:hidden bg-brandAccent text-white px-3 py-1.5 rounded-lg">Start</a>
    </div>
  </header>

  <!-- Hero -->
  <br><br>
  <section class="pt-24 md:pt-28">
    <div class="hero-img">
      <div class="backdrop-brightness-90 bg-gradient-to-r from-brandPrimary/70 to-brandAccent/60">
        <div class="max-w-3xl mx-auto px-4 py-12 text-white">
          <h1 class="text-4xl md:text-5xl font-extrabold leading-tight">Welcome back</h1>
          <p class="mt-3 text-white/95">Log in to view your saved calcs, HS suggestions, and chat history.</p>
        </div>
      </div>
    </div>
  </section>
  <br><br><br>

  <!-- Login card -->
  <main class="max-w-3xl mx-auto px-4 -mt-10">
    <div class="bg-white border border-brandBorder rounded-2xl shadow p-6 md:p-8">
      <p id="status" class="text-sm text-brandMuted mb-3"></p>

      <form id="loginForm" class="grid gap-5" autocomplete="on">
        <div class="grid md:grid-cols-2 gap-4">
          <label class="grid gap-1 text-sm">
            <span class="font-medium">Email</span>
            <input name="email" id="email" type="email" class="border border-brandBorder rounded-lg px-3 py-2" placeholder="you@example.com" required>
          </label>
          <label class="grid gap-1 text-sm">
            <span class="font-medium">Password</span>
            <input name="password" id="password" type="password" class="border border-brandBorder rounded-lg px-3 py-2" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
          </label>
        </div>

        <div class="flex items-center justify-between text-sm">
          <label class="inline-flex items-center gap-2">
            <input id="remember" type="checkbox" class="h-4 w-4 border border-brandBorder rounded">
            <span>Remember me</span>
          </label>
          <a id="forgot" href="#" class="text-brandAccent hover:underline">Forgot password?</a>
        </div>

        <button class="bg-brandAccent text-white px-4 py-2 rounded-lg text-base font-semibold" type="submit">
          Log in
        </button>

        <p class="text-sm text-brandMuted">
          Don‚Äôt have an account?
          <a href="personal-sign-up.html" class="text-brandAccent hover:underline">Create one</a>.
        </p>
      </form>

      <div class="mt-6 text-sm">
        <a href="index.html" class="text-brandAccent">‚Üê Back to home</a>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="text-center text-xs text-brandMuted mt-10 mb-8">
    ¬© <span id="year"></span> Chadaddy
  </footer>

  <!-- üîê Reset Password Modal -->
  <div id="resetModal" class="hidden fixed inset-0 z-[1000] flex items-center justify-center bg-black/50 p-4">
    <div class="w-full max-w-md rounded-2xl bg-white shadow-xl border border-brandBorder">
      <div class="p-5 border-b border-brandBorder">
        <h3 class="text-lg font-bold">Set a new password</h3>
        <p class="text-sm text-brandMuted mt-1">Enter your new password below.</p>
      </div>
      <form id="resetForm" class="p-5 grid gap-3">
        <input id="newPass" type="password" class="border border-brandBorder rounded-lg px-3 py-2 w-full" placeholder="New password" required minlength="6">
        <input id="newPass2" type="password" class="border border-brandBorder rounded-lg px-3 py-2 w-full" placeholder="Confirm new password" required minlength="6">
        <div class="flex gap-2 mt-2">
          <button id="btnReset" type="submit" class="flex-1 px-4 py-2 rounded-lg bg-brandAccent text-white font-semibold">Update password</button>
          <button type="button" id="btnCancelReset" class="px-4 py-2 rounded-lg border border-brandBorder">Cancel</button>
        </div>
        <p id="resetStatus" class="text-xs text-brandMuted"></p>
      </form>
    </div>
  </div>

  <!-- Supabase auth wiring -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // ‚úÖ Your project values
    const SUPABASE_URL = "https://nkvrhaxpoehqcgoamjhq.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5rdnJoYXhwb2VocWNnb2FtamhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3OTc5MDcsImV4cCI6MjA3MTM3MzkwN30.I6azwaIiEsQ_EjFRXtIZFTvpcc_g6NccsC3pJdWQPks";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });

    const $ = (s) => document.querySelector(s);
    const statusEl = $("#status");
    const toast = (msg) => { statusEl.textContent = msg; };

    $("#year").textContent = new Date().getFullYear();

    // ---------- Forgot Password (send email) ----------
    $("#forgot").addEventListener("click", async (e) => {
      e.preventDefault();
      const email = $("#email").value.trim();
      if (!email) return toast("Enter your email first, then click Forgot password.");

      // Redirect back to THIS page so we can show the reset modal when the link is opened
      const redirectTo = `${location.origin}/log-in.html`;
      try {
        const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo });
        if (error) throw error;
        toast("Password reset email sent. Please check your inbox.");
      } catch (err) {
        console.error("resetPasswordForEmail error:", err);
        toast(err?.message || "Could not send reset email.");
      }
    });

    // ---------- Listen for recovery event & show reset modal ----------
    const resetModal = $("#resetModal");
    const resetForm = $("#resetForm");
    const resetStatus = $("#resetStatus");
    const btnCancelReset = $("#btnCancelReset");

    const showReset = () => resetModal.classList.remove("hidden");
    const hideReset = () => resetModal.classList.add("hidden");

    // Supabase fires PASSWORD_RECOVERY when the reset link is opened
    supabase.auth.onAuthStateChange((event) => {
      if (event === "PASSWORD_RECOVERY") {
        showReset();
      }
    });

    // Fallback: if the URL hash has type=recovery (some browsers), show modal
    const hash = location.hash || "";
    if (hash.includes("type=recovery")) {
      showReset();
    }

    btnCancelReset.addEventListener("click", hideReset);

    // ---------- Handle setting the new password ----------
    resetForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      resetStatus.textContent = "";

      const p1 = $("#newPass").value.trim();
      const p2 = $("#newPass2").value.trim();
      if (!p1 || p1.length < 6) return resetStatus.textContent = "Password must be at least 6 characters.";
      if (p1 !== p2) return resetStatus.textContent = "Passwords do not match.";

      $("#btnReset").disabled = true;
      $("#btnReset").textContent = "Updating‚Ä¶";

      try {
        // This updates the password for the user associated with the recovery token in the URL
        const { data, error } = await supabase.auth.updateUser({ password: p1 });
        if (error) throw error;

        resetStatus.textContent = "‚úÖ Password updated. Please sign in.";
        // Optional: sign out any existing session just in case
        await supabase.auth.signOut();
        setTimeout(() => {
          hideReset();
          // Focus back to login form
          $("#password").focus();
          toast("Password updated. Please sign in.");
        }, 600);
      } catch (err) {
        console.error("updateUser error:", err);
        resetStatus.textContent = err?.message || "Could not update password.";
      } finally {
        $("#btnReset").disabled = false;
        $("#btnReset").textContent = "Update password";
      }
    });

    // ---------- If already logged in, go straight to dashboard ----------
    (async () => {
      const { data: { session }, error } = await supabase.auth.getSession();
      if (error) console.warn("getSession error:", error.message);
      if (session?.user) {
        const user = session.user;
        const name = (user.user_metadata?.full_name) || (user.email?.split("@")[0]) || "User";
        localStorage.setItem("chadaddy_user", JSON.stringify({ email: user.email, name, ts: Date.now() }));
        location.href = "dashboard.html";
      }
    })();

    // ---------- Normal login ----------
    $("#loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData(e.currentTarget);
      const email = (fd.get("email") || "").trim();
      const password = (fd.get("password") || "").trim();
      const remember = $("#remember").checked;

      if (!email || !password) return toast("Please enter email and password.");

      try {
        toast("Signing in‚Ä¶");
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;

        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
          const full_name = user.user_metadata?.full_name || null;
          await supabase.from("profiles").upsert({ user_id: user.id, full_name });
          const name = full_name || (user.email?.split("@")[0]) || "User";
          localStorage.setItem("chadaddy_user", JSON.stringify({ email: user.email, name, remember, ts: Date.now() }));
        }

        toast("Success! Redirecting‚Ä¶");
        setTimeout(() => { location.href = "dashboard.html"; }, 600);
      } catch (err) {
        console.error(err);
        toast(err?.message || "Login failed.");
      }
    });
  </script>
</body>
</html>

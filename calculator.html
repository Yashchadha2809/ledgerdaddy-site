<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Global Duty & Landed Cost – Chadaddy</title>
  <meta name="theme-color" content="#111827" />
  <link rel="preconnect" href="https://images.unsplash.com" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors:{
            brandPrimary:"#111827",
            brandAccent:"#2563EB",
            brandSoft:"#EFF6FF",
            brandBorder:"#E5E7EB",
            brandMuted:"#6B7280",
            brandBg:"#F9FAFB"
          },
          boxShadow:{ lift:"0 14px 34px rgba(17,24,39,.06)" },
          backgroundImage:{
            "soft-gradient":"linear-gradient(135deg, #EFF6FF 0%, #FFFFFF 100%)"
          }
        }
      }
    }
  </script>
  <style>
    .card{transition:transform .12s ease, box-shadow .2s ease}
    .card:hover{transform:translateY(-2px); box-shadow:0 14px 34px rgba(17,24,39,.10)}
    .hero-img{background:url('https://images.unsplash.com/photo-1586521995568-39ef16c6934d?q=80&w=1920&auto=format&fit=crop') center/cover no-repeat;}
  </style>
</head>
<body class="bg-brandBg text-brandPrimary">

  <!-- Topbar (UPDATED LINKS) -->
  <header class="fixed top-0 inset-x-0 z-50 border-b border-brandBorder bg-white/90 backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="/" class="flex items-center gap-2" aria-label="Home">
        <span class="grid h-9 w-9 place-items-center rounded-xl bg-soft-gradient text-brandPrimary font-extrabold shadow">◆</span>
        <span class="text-xl font-bold">Chadaddy</span>
        <span class="ml-2 hidden sm:inline-flex text-[11px] px-2 py-0.5 rounded-full border border-brandAccent/40 text-brandAccent">AI Customs</span>
      </a>
      <nav class="hidden md:flex items-center gap-6 text-sm font-medium" aria-label="Main">
        <a href="https://www.ledgerdaddy.com/marketplace.html" class="hover:text-brandAccent">Marketplace</a>
        <a href="https://www.ledgerdaddy.com/calculator.html" class="hover:text-brandAccent text-brandAccent">Calculator</a>
        <a href="https://www.ledgerdaddy.com/hs-finder.html" class="hover:text-brandAccent">HS Finder</a>
        <a href="https://www.ledgerdaddy.com/chat.html" class="hover:text-brandAccent">Chat</a>
      </nav>
      <!-- Always session-based user controls -->
      <div id="userControls" class="flex items-center gap-3"></div>
    </div>
  </header>

  <!-- Hero -->
  <section class="pt-24 md:pt-28">
    <div class="hero-img">
      <div class="backdrop-brightness-90 bg-gradient-to-r from-brandPrimary/70 to-brandAccent/60">
        <div class="max-w-5xl mx-auto px-4 py-12 text-white">
          <h1 class="text-4xl md:text-5xl font-extrabold leading-tight">Global Duty & Landed Cost</h1>
          <p class="mt-3 text-white/95">Get a quick estimate for BCD, VAT/IGST and landed cost. (Uses backend if available; falls back to demo.)</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Calculator -->
  <main class="max-w-5xl mx-auto px-4 -mt-10">
    <div class="bg-white border border-brandBorder rounded-2xl shadow p-6 md:p-8">
      <form id="calcForm" class="grid md:grid-cols-2 gap-6 items-start">
        <section class="grid gap-3">

          <!-- Import + Destination -->
          <div class="grid grid-cols-2 gap-3">
            <label class="grid gap-1 text-sm">
              <span class="font-medium">Import Country</span>
              <select id="cCountry" class="border border-brandBorder rounded-lg px-3 py-2">
                <option>IN</option><option>US</option><option>EU</option><option>UK</option>
              </select>
            </label>
            <label class="grid gap-1 text-sm">
              <span class="font-medium">Destination</span>
              <select id="cDestCountry" class="border border-brandBorder rounded-lg px-3 py-2">
                <option>US</option><option>EU</option><option>UK</option><option>IN</option>
              </select>
            </label>
          </div>

          <!-- Incoterm -->
          <label class="grid gap-1 text-sm">
            <span class="font-medium">Incoterm</span>
            <select id="cIncoterm" class="border border-brandBorder rounded-lg px-3 py-2">
              <option value="CIF">CIF</option>
              <option value="FOB">FOB</option>
              <option value="EXW">EXW</option>
            </select>
          </label>

          <!-- HS + Goods -->
          <div class="grid grid-cols-2 gap-3">
            <label class="grid gap-1 text-sm">
              <span class="font-medium">HS Code</span>
              <input id="cHS" class="border border-brandBorder rounded-lg px-3 py-2" placeholder="e.g. 851713" required title="6-digit HS Code (mandatory)"/>
            </label>
            <label class="grid gap-1 text-sm">
              <span class="font-medium">Goods Value</span>
              <input id="cGoods" type="number" class="border border-brandBorder rounded-lg px-3 py-2" placeholder="e.g. 100000" required title="Declared FOB or CIF goods value"/>
            </label>
          </div>

          <!-- Freight/Ins/Other -->
          <div class="grid grid-cols-3 gap-3">
            <label class="grid gap-1 text-sm">
              <span class="font-medium">Freight (optional)</span>
              <input id="cFreight" type="number" class="border border-brandBorder rounded-lg px-3 py-2" placeholder="0" title="Leave 0 if not applicable"/>
            </label>
            <label class="grid gap-1 text-sm">
              <span class="font-medium">Insurance (optional)</span>
              <input id="cIns" type="number" class="border border-brandBorder rounded-lg px-3 py-2" placeholder="0" title="Leave 0 if not applicable"/>
            </label>
            <label class="grid gap-1 text-sm">
              <span class="font-medium">Other includable (optional)</span>
              <input id="cOther" type="number" class="border border-brandBorder rounded-lg px-3 py-2" placeholder="0"/>
            </label>
          </div>

          <!-- Advanced -->
          <details class="p-3 border border-brandBorder rounded-lg">
            <summary class="cursor-pointer font-medium">Advanced (optional)</summary>
            <div class="grid grid-cols-3 gap-3 mt-3 text-sm">
              <label class="grid gap-1">
                <span>Override duty %</span>
                <input id="cDuty" type="number" class="border border-brandBorder rounded-lg px-3 py-2" placeholder="auto" title="Auto-calculated if left blank"/>
              </label>
              <label class="grid gap-1">
                <span>VAT/IGST %</span>
                <input id="cVat" type="number" class="border border-brandBorder rounded-lg px-3 py-2" placeholder="auto" title="Auto-calculated if left blank"/>
              </label>
              <label class="grid gap-1">
                <span>AIDC/Cess %</span>
                <input id="cAidc" type="number" class="border border-brandBorder rounded-lg px-3 py-2" placeholder="0" title="Enter if applicable"/>
              </label>
            </div>
          </details>

          <!-- Buttons -->
          <div class="flex items-center gap-3">
            <button id="calcBtn" class="bg-brandAccent text-white py-2 px-4 rounded-lg" type="submit">Calculate</button>
            <label class="text-sm inline-flex items-center gap-2 text-brandPrimary">
              <input id="ftaToggle" type="checkbox" class="h-4 w-4 border border-brandBorder rounded"> 
              FTA savings (demo only: reduces duty by 5%)
            </label>
          </div>

          <p class="text-xs text-brandMuted">Backend path: <code class="bg-brandBg px-1 py-0.5 rounded">/duty/calc</code> (IN only). If unavailable, this page falls back to demo logic.</p>
        </section>

        <!-- Results -->
        <section>
          <h3 class="font-semibold mb-2">Breakdown</h3>
          <div class="overflow-hidden rounded-xl border border-brandBorder">
            <table class="w-full text-sm">
              <thead class="bg-brandSoft">
                <tr>
                  <th class="px-3 py-2 text-left">Component</th>
                  <th class="px-3 py-2 text-right">Basis</th>
                  <th class="px-3 py-2 text-right">Rate</th>
                  <th class="px-3 py-2 text-right">Amount</th>
                </tr>
              </thead>
              <tbody id="cTable" class="divide-y divide-brandBorder">
                <tr><td class="px-3 py-3 text-center text-brandMuted" colspan="4">No results yet — run a calculation.</td></tr>
              </tbody>
            </table>
          </div>

          <div id="hsSuggestBox" class="hidden mt-3 p-3 border border-brandBorder rounded-lg bg-white">
            <strong>HS suggestions</strong>
            <ul id="hsSuggestList" class="list-disc ml-5 text-sm"></ul>
            <p class="text-xs text-brandMuted mt-1">Customs makes the final decision.</p>
          </div>

          <div id="totalCard" class="hidden mt-4 p-4 rounded-xl border border-brandBorder bg-brandSoft">
            <div class="text-sm text-brandMuted">Estimated total landed cost</div>
            <div id="totalVal" class="text-2xl font-extrabold mt-1">—</div>
          </div>
        </section>
      </form>

      <div class="mt-6 text-sm flex items-center justify-between">
        <a href="/" class="text-brandAccent">← Back to home</a>
        <a href="/dashboard" class="underline">Go to dashboard</a>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="text-center text-xs text-brandMuted mt-10 mb-8">
    © <span id="year"></span> Chadaddy
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
    const API_BASE = ""; // same-origin or backend URL
    const $ = s => document.querySelector(s);

    // SESSION ENFORCEMENT
    async function checkSession(){
      try{
        const res = await fetch(`${API_BASE}/auth/session`, {credentials:"include"});
        if(res.ok){
          const data = await res.json();
          if(data?.user){
            document.getElementById('userControls').innerHTML = 
              `<span class="text-sm">Hi, ${data.user.name || "User"}</span>
               <a href="/dashboard" class="bg-brandAccent text-white px-4 py-2 rounded-lg">Dashboard</a>
               <a href="/log-out" class="text-sm text-brandMuted">Log out</a>`;
          } else {
            window.location.href="/log-in";
          }
        } else {
          window.location.href="/log-in";
        }
      }catch(_){
        window.location.href="/log-in";
      }
    }
    checkSession();

    // ===== Helpers =====
    function addRow(label,basis,rate,amount){
      return `<tr>
        <td class="px-3 py-2">${label}</td>
        <td class="px-3 py-2 text-right">${Number.isFinite(basis)?basis.toLocaleString(): '—'}</td>
        <td class="px-3 py-2 text-right">${(rate ?? '') !== '' ? rate + '%' : '—'}</td>
        <td class="px-3 py-2 text-right font-semibold">${Number.isFinite(amount)?Math.round(amount).toLocaleString(): '—'}</td>
      </tr>`;
    }
    const currencyByCountry = { IN: 'INR', US: 'USD', EU: 'EUR', UK: 'GBP' };
    const symbolByCcy = { INR:'₹', USD:'$', EUR:'€', GBP:'£' };
    function symForCountry(country){ const ccy = currencyByCountry[country] || 'USD'; return symbolByCcy[ccy] || ''; }
    function setBusy(busy){ const btn = $('#calcBtn'); btn.disabled = !!busy; btn.textContent = busy ? 'Calculating…' : 'Calculate'; }

    // DEMO calc
    function demoCalc({country, goods, freight, ins, other, override, vatIn, aidcIn, fta}){
      const AV = goods + freight + ins + other;
      let baseDuty = isNaN(override)?({IN:10,US:3,EU:5,UK:5}[country]||10):override;
      if(fta) baseDuty = Math.max(0, baseDuty - 5);
      const vatRate = isNaN(vatIn)?({IN:18,US:0.9,EU:20,UK:20}[country]||18):vatIn;
      const aidcRate = isNaN(aidcIn)?0:aidcIn;
      const BCD = AV * baseDuty / 100;
      const SWS = (country==='IN') ? BCD * 0.10 : 0;
      const AIDC = AV * aidcRate / 100;
      const sub = AV + BCD + SWS + AIDC;
      const VAT = sub * (vatRate/100);
      const total = sub + VAT;
      return { AV, baseDuty, vatRate, aidcRate, BCD, SWS, AIDC, sub, VAT, total };
    }

    // Run calculation
    async function runCalc(){
      const country = $('#cCountry').value.trim();
      const dest = $('#cDestCountry').value.trim();
      const hs = $('#cHS').value.trim();
      const goods = +($('#cGoods').value||0);
      const freight = +($('#cFreight').value||0);
      const ins = +($('#cIns').value||0);
      const other = +($('#cOther').value||0);
      const override = +($('#cDuty').value||NaN);
      const vatIn = +($('#cVat').value||NaN);
      const aidcIn = +($('#cAidc').value||NaN);
      const fta = $('#ftaToggle').checked;
      const incoterm = $('#cIncoterm').value;

      if(!goods){ alert('Please enter Goods Value'); return; }
      setBusy(true);
      const tb = $('#cTable');
      const sym = symForCountry(country);

      const payload = {
        import_country: country,
        destination_country: dest,
        export_country: "CN",
        hs_code: hs,
        incoterm: incoterm,
        currency: currencyByCountry[country] || "USD",
        fob: goods,
        freight: freight,
        insurance: ins
      };

      try{
        const res = await fetch(`${API_BASE}/duty/calc`, {
          method: "POST", headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload), cache: "no-store"
        });
        const data = await res.json();
        if(res.ok && !data.error){
          const AV = +data.cif_value || (goods + freight + ins);
          const bcdRate = data.components?.bcd?.rate_pct ?? '';
          const bcdAmt  = data.components?.bcd?.amount ?? 0;
          const swsAmt  = data.components?.sws?.amount ?? 0;
          const igstRate= data.components?.igst?.rate_pct ?? '';
          const igstAmt = data.components?.igst?.amount ?? 0;
          const totalTaxes = data.total_taxes ?? (bcdAmt + swsAmt + igstAmt);
          const total = AV + totalTaxes;
          tb.innerHTML =
            addRow('Assessable Value (CIF basis)', AV, '', AV) +
            addRow('BCD', AV, bcdRate, bcdAmt) +
            (swsAmt ? addRow('SWS (10% of BCD)', bcdAmt, 10, swsAmt) : '') +
            addRow(country==='IN'?'IGST':'VAT', AV + bcdAmt + swsAmt, igstRate, igstAmt) +
            `<tr class="bg-brandSoft font-semibold"><td class="px-3 py-2" colspan="3">Total Landed Cost</td><td class="px-3 py-2 text-right">${sym} ${Math.round(total).toLocaleString()}</td></tr>`;
        } else {
          // Fallback to demo calc
          const demo = demoCalc({
            country, goods, freight, ins, other,
            override, vatIn, aidcIn, fta
          });
          tb.innerHTML =
            addRow('Assessable Value (CIF basis)', demo.AV, '', demo.AV) +
            addRow('BCD', demo.AV, demo.baseDuty, demo.BCD) +
            (demo.SWS ? addRow('SWS (10% of BCD)', demo.BCD, 10, demo.SWS) : '') +
            addRow(country==='IN'?'IGST':'VAT', demo.sub, demo.vatRate, demo.VAT) +
            (demo.AIDC ? addRow('AIDC/Cess', demo.AV, demo.aidcRate, demo.AIDC) : '') +
            `<tr class="bg-brandSoft font-semibold"><td class="px-3 py-2" colspan="3">Total Landed Cost</td><td class="px-3 py-2 text-right">${sym} ${Math.round(demo.total).toLocaleString()}</td></tr>`;
        }
      } catch (e){
        // On hard error, also fallback
        const demo = demoCalc({
          country, goods, freight, ins, other,
          override, vatIn, aidcIn, fta
        });
        tb.innerHTML =
          addRow('Assessable Value (CIF basis)', demo.AV, '', demo.AV) +
          addRow('BCD', demo.AV, demo.baseDuty, demo.BCD) +
          (demo.SWS ? addRow('SWS (10% of BCD)', demo.BCD, 10, demo.SWS) : '') +
          addRow(country==='IN'?'IGST':'VAT', demo.sub, demo.vatRate, demo.VAT) +
          (demo.AIDC ? addRow('AIDC/Cess', demo.AV, demo.aidcRate, demo.AIDC) : '') +
          `<tr class="bg-brandSoft font-semibold"><td class="px-3 py-2" colspan="3">Total Landed Cost</td><td class="px-3 py-2 text-right">${sym} ${Math.round(demo.total).toLocaleString()}</td></tr>`;
      } finally {
        setBusy(false);
        // Reveal total
        const totalCard = document.getElementById('totalCard');
        const totalText = (document.querySelector('#cTable tr:last-child td:last-child')?.textContent || '—').trim();
        if(totalText !== '—'){ 
          document.getElementById('totalVal').textContent = totalText.replace(/^[^\d₹$€£]*/, '');
          totalCard.classList.remove('hidden');
        }
      }
    }

    document.getElementById('calcForm').addEventListener('submit', e => {
      e.preventDefault();
      runCalc();
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Global Duty & Landed Cost – Ledgerdaddy</title>
  <meta name="theme-color" content="#1A237E" />
  <link rel="preconnect" href="https://images.unsplash.com" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors:{ indigoDeep:"#1A237E", emerald:"#2E7D32", cyanBright:"#00BCD4", accentOrange:"#FF7043" },
          boxShadow:{ lift:"0 14px 34px rgba(0,0,0,.12)" }
        }
      }
    }
  </script>
  <style>
    .card{transition:transform .12s ease, box-shadow .2s ease}
    .card:hover{transform:translateY(-2px); box-shadow:0 14px 34px rgba(0,0,0,.14)}
    .hero-img{background:url('https://images.unsplash.com/photo-1586521995568-39ef16c6934d?q=80&w=1920&auto=format&fit=crop') center/cover no-repeat;}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">

  <!-- Topbar -->
  <header class="fixed top-0 inset-x-0 z-50 border-b border-gray-200 bg-white/90 backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="/" class="flex items-center gap-2" aria-label="Home">
        <span class="grid h-9 w-9 place-items-center rounded-xl bg-gradient-to-tr from-cyanBright to-emerald text-white font-extrabold shadow">◆</span>
        <span class="text-xl font-bold text-indigoDeep">Ledgerdaddy</span>
        <span class="ml-2 hidden sm:inline-flex text-[11px] px-2 py-0.5 rounded-full border border-cyanBright/40 text-cyanBright">AI Customs</span>
      </a>
      <nav class="hidden md:flex items-center gap-6 text-sm font-medium" aria-label="Main">
        <a href="/#marketplace" class="hover:text-cyanBright">Marketplace</a>
        <a href="/calculator" class="hover:text-cyanBright text-cyanBright">Calculator</a>
        <a href="/#hsfinder" class="hover:text-cyanBright">HS Finder</a>
        <a href="/#chat" class="hover:text-cyanBright">Chat</a>
        <a href="/#news" class="hover:text-cyanBright">News</a>
        <a href="/#learn" class="hover:text-cyanBright">Academy</a>
        <a href="/#pricing" class="hover:text-cyanBright">Pricing</a>
      </nav>
      <div class="hidden md:flex items-center gap-2">
        <a href="/log-in" class="border px-4 py-2 rounded-lg">Log in</a>
        <a href="/personal-sign-up" class="bg-emerald text-white px-4 py-2 rounded-lg hover:opacity-95">Sign up</a>
      </div>
      <a href="/personal-sign-up" class="md:hidden bg-emerald text-white px-3 py-1.5 rounded-lg">Start</a>
    </div>
  </header>

  <!-- Hero -->
  <section class="pt-24 md:pt-28">
    <div class="hero-img">
      <div class="backdrop-brightness-90 bg-gradient-to-r from-indigoDeep/70 to-cyanBright/60">
        <div class="max-w-5xl mx-auto px-4 py-12 text-white">
          <h1 class="text-4xl md:text-5xl font-extrabold leading-tight">Global Duty & Landed Cost</h1>
          <p class="mt-3 text-white/95">Get a quick estimate for BCD, VAT/IGST and landed cost. (Uses backend if available; falls back to demo.)</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Calculator -->
  <main class="max-w-5xl mx-auto px-4 -mt-10">
    <div class="bg-white border border-gray-200 rounded-2xl shadow p-6 md:p-8">
      <form id="calcForm" class="grid md:grid-cols-2 gap-6 items-start">
        <section class="grid gap-3">
          <div class="grid grid-cols-2 gap-3">
            <label class="grid gap-1 text-sm">
              <span class="font-medium">Country</span>
              <select id="cCountry" class="border rounded-lg px-3 py-2">
                <option>IN</option><option>US</option><option>EU</option><option>UK</option>
              </select>
            </label>
            <label class="grid gap-1 text-sm">
              <span class="font-medium">Incoterm</span>
              <select id="cIncoterm" class="border rounded-lg px-3 py-2">
                <option value="CIF">CIF</option>
                <option value="FOB">FOB</option>
                <option value="EXW">EXW</option>
              </select>
            </label>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <label class="grid gap-1 text-sm">
              <span class="font-medium">HS Code</span>
              <input id="cHS" class="border rounded-lg px-3 py-2" placeholder="e.g. 851713" required />
            </label>
            <label class="grid gap-1 text-sm">
              <span class="font-medium">Goods Value</span>
              <input id="cGoods" type="number" class="border rounded-lg px-3 py-2" placeholder="e.g. 100000" required />
            </label>
          </div>

          <div class="grid grid-cols-3 gap-3">
            <label class="grid gap-1 text-sm">
              <span class="font-medium">Freight</span>
              <input id="cFreight" type="number" class="border rounded-lg px-3 py-2" placeholder="0" />
            </label>
            <label class="grid gap-1 text-sm">
              <span class="font-medium">Insurance</span>
              <input id="cIns" type="number" class="border rounded-lg px-3 py-2" placeholder="0" />
            </label>
            <label class="grid gap-1 text-sm">
              <span class="font-medium">Other includable</span>
              <input id="cOther" type="number" class="border rounded-lg px-3 py-2" placeholder="0" />
            </label>
          </div>

          <details class="p-3 border rounded-lg">
            <summary class="cursor-pointer font-medium">Advanced (optional)</summary>
            <div class="grid grid-cols-3 gap-3 mt-3 text-sm">
              <label class="grid gap-1">
                <span>Override duty %</span>
                <input id="cDuty" type="number" class="border rounded-lg px-3 py-2" placeholder="auto" />
              </label>
              <label class="grid gap-1">
                <span>VAT/IGST %</span>
                <input id="cVat" type="number" class="border rounded-lg px-3 py-2" placeholder="auto" />
              </label>
              <label class="grid gap-1">
                <span>AIDC/Cess %</span>
                <input id="cAidc" type="number" class="border rounded-lg px-3 py-2" placeholder="0" />
              </label>
            </div>
          </details>

          <div class="flex items-center gap-3">
            <button id="calcBtn" class="bg-emerald text-white py-2 px-4 rounded-lg" type="submit">Calculate</button>
            <label class="text-sm inline-flex items-center gap-2">
              <input id="ftaToggle" type="checkbox" class="h-4 w-4 border rounded"> Apply FTA savings (demo)
            </label>
          </div>

          <p class="text-xs text-gray-600">Backend path: <code>/duty/calc</code> (IN only). If unavailable, this page falls back to demo logic.</p>
        </section>

        <section>
          <h3 class="font-semibold mb-2">Breakdown</h3>
          <div class="overflow-hidden rounded-xl border border-gray-200">
            <table class="w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-3 py-2 text-left">Component</th>
                  <th class="px-3 py-2 text-right">Basis</th>
                  <th class="px-3 py-2 text-right">Rate</th>
                  <th class="px-3 py-2 text-right">Amount</th>
                </tr>
              </thead>
              <tbody id="cTable" class="divide-y divide-gray-200">
                <tr><td class="px-3 py-3 text-center text-gray-500" colspan="4">No results yet — run a calculation.</td></tr>
              </tbody>
            </table>
          </div>

          <div id="hsSuggestBox" class="hidden mt-3 p-3 border rounded-lg bg-white">
            <strong>HS suggestions</strong>
            <ul id="hsSuggestList" class="list-disc ml-5 text-sm"></ul>
            <p class="text-xs text-gray-500 mt-1">Customs makes the final decision.</p>
          </div>

          <div id="totalCard" class="hidden mt-4 p-4 rounded-xl border bg-gray-50">
            <div class="text-sm text-gray-600">Estimated total landed cost</div>
            <div id="totalVal" class="text-2xl font-extrabold mt-1">—</div>
          </div>
        </section>
      </form>

      <div class="mt-6 text-sm flex items-center justify-between">
        <a href="/" class="text-cyanBright">← Back to home</a>
        <a href="/dashboard" class="underline">Go to dashboard</a>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="text-center text-xs text-gray-500 mt-10 mb-8">
    © <span id="year"></span> Ledgerdaddy
  </footer>

  <script>
    // Footer year
    document.getElementById('year').textContent = new Date().getFullYear();

    // ====== CONFIG ======
    // If the page is hosted on the SAME domain as Flask, you can use an empty string "".
    // Otherwise set your Render base, e.g. "https://chadaddy.onrender.com"
    const API_BASE = ""; // "" means same-origin. Set to your full API origin if different.

    // ====== Helpers ======
    const $  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    function addRow(label,basis,rate,amount){
      return `<tr>
        <td class="px-3 py-2">${label}</td>
        <td class="px-3 py-2 text-right">${Number.isFinite(basis)?basis.toLocaleString(): '—'}</td>
        <td class="px-3 py-2 text-right">${(rate ?? '') !== '' ? rate + '%' : '—'}</td>
        <td class="px-3 py-2 text-right font-semibold">${Number.isFinite(amount)?Math.round(amount).toLocaleString(): '—'}</td>
      </tr>`;
    }

    const currencyByCountry = { IN: 'INR', US: 'USD', EU: 'EUR', UK: 'GBP' };
    const symbolByCcy = { INR:'₹', USD:'$', EUR:'€', GBP:'£' };

    function symForCountry(country){
      const ccy = currencyByCountry[country] || 'USD';
      return symbolByCcy[ccy] || '';
    }

    function setBusy(busy){
      const btn = $('#calcBtn');
      btn.disabled = !!busy;
      btn.textContent = busy ? 'Calculating…' : 'Calculate';
    }

    async function tryHsSuggest(hsOrQuery, country){
      const box = $('#hsSuggestBox');
      const list = $('#hsSuggestList');

      // Only suggest if the HS looks short
      if(!hsOrQuery || hsOrQuery.trim().length >= 6){
        box.classList.add('hidden');
        return;
      }

      // Attempt backend suggestions if available
      try{
        const url = `${API_BASE}/hsn/suggest?country=${encodeURIComponent(country)}&q=${encodeURIComponent(hsOrQuery)}`;
        const res = await fetch(url, { method: 'GET', cache: 'no-store' });
        if(res.ok){
          const data = await res.json();
          if(Array.isArray(data?.suggestions) && data.suggestions.length){
            list.innerHTML = data.suggestions.slice(0,5).map(s =>
              `<li>${s.text || s.code || s} ${s.confidence ? `<span class="text-xs text-gray-500">confidence ${s.confidence}%</span>`:''}</li>`
            ).join('');
            box.classList.remove('hidden');
            return;
          }
        }
      }catch(_){ /* ignore */ }

      // Fallback static suggestions
      list.innerHTML = [
        '851713 – Phones',
        '851762 – Comm. equip',
        '850760 – Li-ion cells'
      ].map((s,i)=>`<li>${s} <span class="text-xs text-gray-500">confidence ${85 - i*10}%</span></li>`).join('');
      box.classList.remove('hidden');
    }

    // ====== Demo fallback math (what you already had) ======
    function demoCalc({country, goods, freight, ins, other, override, vatIn, aidcIn, fta}){
      const AV = goods + freight + ins + other;
      let baseDuty = isNaN(override)?({IN:10,US:3,EU:5,UK:5}[country]||10):override;
      if(fta) baseDuty = Math.max(0, baseDuty - 5);
      const vatRate = isNaN(vatIn)?({IN:18,US:0.9,EU:20,UK:20}[country]||18):vatIn;
      const aidcRate = isNaN(aidcIn)?({IN:0,US:0,EU:0,UK:0}[country]||0):aidcIn;

      const BCD = AV * baseDuty / 100;
      const SWS = (country==='IN') ? BCD * 0.10 : 0;
      const AIDC = AV * aidcRate / 100;

      const sub = AV + BCD + SWS + AIDC;
      const VAT = sub * (vatRate/100);
      const total = sub + VAT;

      return { AV, baseDuty, vatRate, aidcRate, BCD, SWS, AIDC, sub, VAT, total };
    }

    // ====== Backend-first calculation ======
    async function runCalc(){
      const country = $('#cCountry').value.trim();
      const hs = $('#cHS').value.trim();
      const goods = +($('#cGoods').value||0);
      const freight = +($('#cFreight').value||0);
      const ins = +($('#cIns').value||0);
      const other = +($('#cOther').value||0);
      const override = +($('#cDuty').value||NaN);
      const vatIn = +($('#cVat').value||NaN);
      const aidcIn = +($('#cAidc').value||NaN);
      const fta = $('#ftaToggle').checked;
      const incoterm = $('#cIncoterm').value;

      if(!goods){ alert('Please enter Goods Value'); return; }

      setBusy(true);
      const tb = $('#cTable');
      const sym = symForCountry(country);

      // Try HS suggestions async (no need to await)
      tryHsSuggest(hs, country);

      // Build payload for backend (India engine expects fob/freight/insurance; we ignore "other")
      const payload = {
        import_country: country,
        export_country: "CN",
        hs_code: hs,
        incoterm: incoterm,
        currency: currencyByCountry[country] || "USD",
        fob: goods,
        freight: freight,
        insurance: ins
      };

      let usedBackend = false;
      try{
        const res = await fetch(`${API_BASE}/duty/calc`, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload),
          cache: "no-store"
        });
        const data = await res.json();

        if(res.ok && !data.error){
          usedBackend = true;

          const AV = +data.cif_value || (goods + freight + ins);
          const bcdRate = data.components?.bcd?.rate_pct ?? '';
          const bcdAmt  = data.components?.bcd?.amount ?? 0;
          const swsRate = data.components?.sws?.rate_pct ?? '';
          const swsAmt  = data.components?.sws?.amount ?? 0;
          const igstRate= data.components?.igst?.rate_pct ?? '';
          const igstAmt = data.components?.igst?.amount ?? 0;
          const adcvdAmt= data.components?.adcvd?.amount ?? 0;
          const totalTaxes = data.total_taxes ?? (bcdAmt + swsAmt + igstAmt + adcvdAmt);
          const total = AV + totalTaxes;

          tb.innerHTML =
            addRow('Assessable Value (CIF basis)', AV, '', AV) +
            addRow('BCD', AV, bcdRate, bcdAmt) +
            (swsAmt ? addRow('SWS (10% of BCD)', bcdAmt, swsRate || 10, swsAmt) : '') +
            (adcvdAmt ? addRow('Anti-dumping/CVD', AV, '', adcvdAmt) : '') +
            addRow(country==='IN'?'IGST':'VAT', AV + bcdAmt + swsAmt + adcvdAmt, igstRate, igstAmt) +
            `<tr class="bg-gray-50 font-semibold">
              <td class="px-3 py-2" colspan="3">Total Landed Cost</td>
              <td class="px-3 py-2 text-right">${sym} ${Math.round(total).toLocaleString()}</td>
            </tr>`;

          $('#totalCard').classList.remove('hidden');
          $('#totalVal').textContent = `${sym} ${Math.round(total).toLocaleString()}`;
        } else {
          // Backend said unsupported (e.g., non-IN) or errored — fall back
          throw new Error(data.error || `HTTP ${res.status}`);
        }
      } catch(_err){
        // DEMO fallback math
        const out = demoCalc({country, goods, freight, ins, other, override, vatIn, aidcIn, fta});
        tb.innerHTML =
          addRow('Assessable Value (AV)', out.AV, '', out.AV) +
          addRow('BCD', out.AV, out.baseDuty, out.BCD) +
          (out.SWS ? addRow('SWS (10% of BCD)', out.BCD, 10, out.SWS) : '') +
          (out.AIDC ? addRow('AIDC/Cess', out.AV, out.aidcRate, out.AIDC) : '') +
          addRow(country==='IN'?'IGST':'VAT', out.sub, out.vatRate, out.VAT) +
          `<tr class="bg-gray-50 font-semibold">
            <td class="px-3 py-2" colspan="3">Total Landed Cost</td>
            <td class="px-3 py-2 text-right">${sym} ${Math.round(out.total).toLocaleString()}</td>
          </tr>`;

        $('#totalCard').classList.remove('hidden');
        $('#totalVal').textContent = `${sym} ${Math.round(out.total).toLocaleString()}`;
      } finally {
        setBusy(false);
      }
    }

    document.getElementById('calcForm').addEventListener('submit', function(e){
      e.preventDefault();
      runCalc();
    });
  </script>
</body>
</html>
